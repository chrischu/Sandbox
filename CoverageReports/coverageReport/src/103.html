<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.BuildTool\Commands\ValidateSchemaCommand.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Xml.Schema;
using JetBrains.Annotations;
using SolutionInspector.Commons.Console;
using SolutionInspector.Commons.Extensions;
using Wrapperator.Interfaces.IO;
using Wrapperator.Interfaces.Xml.Schema;

namespace SolutionInspector.BuildTool.Commands
{
  internal class ValidateSchemaCommand : ConsoleCommandBase&lt;ValidateSchemaCommand.RawArguments, ValidateSchemaCommand.ParsedArguments&gt;
  {
    private readonly IFileStatic _file;
    private readonly IXmlSchemaStatic _xmlSchema;

    public ValidateSchemaCommand (IFileStatic file, IXmlSchemaStatic xmlSchema)
        : base(&quot;validateSchema&quot;, &quot;Validates a XSD file.&quot;)
    {
      _file = file;
      _xmlSchema = xmlSchema;
    }

    protected override void SetupArguments (IArgumentsBuilder&lt;RawArguments&gt; argumentsBuilder)
    {
      argumentsBuilder.Values(c =&gt; c.Value(&quot;xsdFilePath&quot;, (a, v) =&gt; a.SchemaPath = v));
    }

    protected override ParsedArguments ValidateAndParseArguments (RawArguments arguments)
    {
      var fileStream = OpenFile(arguments.SchemaPath);
      return new ParsedArguments(arguments.SchemaPath, fileStream);
    }

    private IFileStream OpenFile (string schemaPath)
    {
      try
      {
        return _file.OpenRead(schemaPath);
      }
      catch (FileNotFoundException)
      {
        throw ReportArgumentValidationError($&quot;Schema &#39;{schemaPath}&#39; could not be found&quot;);
      }
      catch (Exception ex)
      {
        throw ReportArgumentValidationError($&quot;Unexpected error while opening schema from &#39;{schemaPath}&#39;&quot;, ex);
      }
    }

    protected override int Run (ParsedArguments arguments)
    {
      var validationEventArgs = new List&lt;ValidationEventArgs&gt;();
      _xmlSchema.Read(arguments.FileStream, (sender, args) =&gt; validationEventArgs.Add(args));

      if (validationEventArgs.Any())
      {
        var errorCount = validationEventArgs.Count(a =&gt; a.Severity == XmlSeverityType.Error);
        var warningCount = validationEventArgs.Count(a =&gt; a.Severity == XmlSeverityType.Warning);

        var message = validationEventArgs.FormatAsList(
            errorCount &gt; 0
                ? $&quot;Schema is not valid (found {errorCount} errors and {warningCount} warnings)&quot;
                : $&quot;Schema is valid but contains {warningCount} warnings&quot;,
            e =&gt; $&quot;{e.Severity.ToString().ToUpper()} on ({e.Exception.LineNumber},{e.Exception.LinePosition}): {e.Message}&quot;);

        if (errorCount &gt; 0)
        {
          LogError(message);
          return ConsoleConstants.ErrorExitCode;
        }
        else
        {
          LogWarning(message);
          return ConsoleConstants.SuccessExitCode;
        }
      }
      else
      {
        LogInfo($&quot;Schema &#39;{arguments.SchemaPath}&#39; is valid&quot;);
        return ConsoleConstants.SuccessExitCode;
      }
    }

    public class RawArguments
    {
      [NotNull]
      // ReSharper disable once NotNullMemberIsNotInitialized (initialized by argument parsing)
      public string SchemaPath { get; set; }
    }

    public class ParsedArguments
    {
      public ParsedArguments (string schemaPath, IFileStream fileStream)
      {
        SchemaPath = schemaPath;
        FileStream = fileStream;
      }

      public string SchemaPath { get; }

      [NotNull]
      public IFileStream FileStream { get; }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[20,11,20,58,1],[22,7,22,20,1],[23,7,23,30,1],[28,7,28,36,1],[28,36,28,69,1],[28,69,28,85,1],[28,85,28,86,1],[28,36,28,86,1],[28,86,28,88,1],[28,7,28,88,1],[33,7,33,55,1],[34,7,34,68,1],[41,9,41,43,1],[43,7,43,36,1],[45,9,45,90,1],[47,7,47,27,1],[49,9,49,111,1],[51,5,51,6,1],[55,7,55,65,1],[56,7,56,63,1],[56,63,56,92,1],[56,92,56,94,1],[56,7,56,94,1],[58,7,58,37,1],[60,9,60,57,1],[60,57,60,92,1],[60,92,60,94,1],[60,9,60,94,1],[61,9,61,59,1],[61,59,61,96,1],[61,96,61,98,1],[61,9,61,98,1],[63,9,67,18,1],[67,18,67,124,1],[67,124,67,126,1],[63,9,67,126,1],[69,9,69,28,1],[71,11,71,29,1],[72,11,72,49,1],[76,11,76,31,1],[77,11,77,51,1],[82,9,82,62,1],[83,9,83,49,1],[96,7,96,73,1],[98,9,98,33,1],[99,9,99,33,1]]);
    </script>
  </body>
</html>