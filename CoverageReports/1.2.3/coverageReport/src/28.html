<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Configuration\Validation\ConfigurationValidator.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using JetBrains.Annotations;
using SolutionInspector.Commons.Extensions;
using SolutionInspector.Configuration.Validation.Dynamic;
using SolutionInspector.Configuration.Validation.Static;

namespace SolutionInspector.Configuration.Validation
{
  /// &lt;summary&gt;
  ///   Utility class to validate configurations.
  /// &lt;/summary&gt;
  public static class ConfigurationValidator
  {
    private static readonly Lazy&lt;List&lt;IStaticConfigurationValidator&gt;&gt; s_staticConfigurationValidators;
    private static readonly Lazy&lt;List&lt;IDynamicConfigurationValidator&gt;&gt; s_dynamicConfigurationValidators;

    static ConfigurationValidator ()
    {
      s_staticConfigurationValidators = new Lazy&lt;List&lt;IStaticConfigurationValidator&gt;&gt;(GetConfigurationValidators&lt;IStaticConfigurationValidator&gt;);
      s_dynamicConfigurationValidators = new Lazy&lt;List&lt;IDynamicConfigurationValidator&gt;&gt;(GetConfigurationValidators&lt;IDynamicConfigurationValidator&gt;);
    }

    private static List&lt;IStaticConfigurationValidator&gt; StaticConfigurationValidators =&gt; s_staticConfigurationValidators.Value;
    private static List&lt;IDynamicConfigurationValidator&gt; DynamicConfigurationValidators =&gt; s_dynamicConfigurationValidators.Value;

    public static void Validate (Type configurationType)
    {
      if (!typeof(ConfigurationBase).IsAssignableFrom(configurationType))
        throw new ArgumentException($&quot;The given type &#39;{configurationType}&#39; does not derive from {typeof(ConfigurationBase)}.&quot;, nameof(configurationType));

      ValidateInternal(configurationType, null);
    }

    public static void Validate (ConfigurationBase configuration)
    {
      ValidateInternal(configuration.GetType(), configuration);
    }

    private static void ValidateInternal (Type configurationType, [CanBeNull] ConfigurationBase configuration)
    {
      var validationErrorCollector = new ConfigurationValidationErrorCollector();

      if (configuration is ConfigurationDocument document &amp;&amp; configuration.Element.Name.LocalName != document.RootElementName)
      {
        validationErrorCollector.AddDocumentError(
            $&quot;The root element of this configuration document must be named &#39;{document.RootElementName}&#39; &quot; +
            $&quot;but it is named &#39;{configuration.Element.Name.LocalName}&#39;.&quot;);
      }

      var compositeValidator = new ValidatingConfigurationVisitor(
          validationErrorCollector,
          StaticConfigurationValidators,
          DynamicConfigurationValidators);

      var staticWalker = new StaticConfigurationTypeWalker();
      staticWalker.Walk(configurationType, compositeValidator);

      if (configuration != null)
      {
        var dynamicWalker = new DynamicConfigurationTypeWalker();
        dynamicWalker.Walk(configuration.GetType(), configuration.Element, compositeValidator);
      }

      if (validationErrorCollector.HasErrors)
        throw new ConfigurationValidationException(validationErrorCollector.DocumentValidationErrors, validationErrorCollector.ValidationErrors);
    }

    private static List&lt;T&gt; GetConfigurationValidators&lt;T&gt; ()
    {
      var validatorType = typeof(T);
      var collection = typeof(ConfigurationValidator).Assembly.GetTypes()
          .Where(t =&gt; validatorType.IsAssignableFrom(t))
          .Where(t =&gt; t.IsClass &amp;&amp; !t.IsAbstract)
          .Select(Activator.CreateInstance)
          .Cast&lt;T&gt;();
      return new List&lt;T&gt;(collection);
    }

    private class ConfigurationValidationErrorCollector : IConfigurationValidationErrorCollector
    {
      private readonly List&lt;string&gt; _documentValidationErrors = new List&lt;string&gt;();
      private readonly Dictionary&lt;string, List&lt;string&gt;&gt; _propertyValidationErrors = new Dictionary&lt;string, List&lt;string&gt;&gt;();

      public IReadOnlyCollection&lt;string&gt; DocumentValidationErrors =&gt; _documentValidationErrors;

      public IReadOnlyDictionary&lt;string, IReadOnlyCollection&lt;string&gt;&gt; ValidationErrors
        =&gt; _propertyValidationErrors.ToDictionary(kvp =&gt; kvp.Key, kvp =&gt; (IReadOnlyCollection&lt;string&gt;) kvp.Value);

      public bool HasErrors =&gt; _documentValidationErrors.Any() || _propertyValidationErrors.Any();

      public void AddDocumentError(string message)
      {
        _documentValidationErrors.Add(message);
      }

      public void AddPropertyError (string propertyPath, string message)
      {
        var propertyErrors = _propertyValidationErrors.GetOrAdd(propertyPath, s =&gt; new List&lt;string&gt;());
        propertyErrors.Add(message);
      }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,7,21,146,1],[22,7,22,149,1],[25,89,25,126,1],[26,91,26,129,1],[30,7,30,74,1],[31,9,31,155,1],[33,7,33,49,1],[38,7,38,64,1],[43,7,43,82,1],[45,7,45,127,1],[47,9,49,75,1],[52,7,55,43,1],[57,7,57,62,1],[58,7,58,64,1],[60,7,60,33,1],[62,9,62,66,1],[63,9,63,96,1],[66,7,66,46,1],[67,9,67,146,1],[72,7,72,37,1],[73,7,74,23,1],[74,23,74,56,1],[74,56,75,23,1],[75,23,75,49,1],[75,49,77,22,1],[73,7,77,22,1],[78,7,78,38,1],[83,7,83,84,1],[84,7,84,124,1],[86,70,86,95,1],[89,12,89,58,1],[89,58,89,65,1],[89,65,89,74,1],[89,74,89,113,1],[89,113,89,114,1],[89,12,89,114,1],[91,32,91,98,1],[95,9,95,48,1],[100,9,100,84,1],[100,84,100,102,1],[100,102,100,104,1],[100,9,100,104,1],[101,9,101,37,1]]);
    </script>
  </body>
</html>