<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Api\Configuration\NameFilter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Text.RegularExpressions;
using JetBrains.Annotations;
using SolutionInspector.Configuration.Attributes;

namespace SolutionInspector.Api.Configuration
{
  /// &lt;inheritdoc /&gt;
  [ConfigurationConverter(typeof(NameFilterConverter))]
  public sealed class NameFilter : INameFilter
  {
    private static readonly Regex s_removeDuplicateAsterisksRegex = new Regex(@&quot;\*+&quot;, RegexOptions.Compiled);

    private readonly Regex[] _excludeFilters;
    private readonly Regex[] _includeFilters;

    /// &lt;inheritdoc /&gt;
    public NameFilter(IEnumerable&lt;string&gt; includes, IEnumerable&lt;string&gt; excludes = null)
    {
      excludes = excludes ?? new string[0];

      Includes = includes as IReadOnlyCollection&lt;string&gt; ?? includes.ToList();
      Excludes = excludes as IReadOnlyCollection&lt;string&gt; ?? excludes.ToList();

      var originalIncludes = Includes;
      Includes = Includes.Except(Excludes).ToList();
      Excludes = Excludes.Except(originalIncludes).ToList();

      Includes = SimplifyFilters(Includes).ToList();
      if (Includes.Count == 0)
        Includes = new[] { &quot;*&quot; };

      Includes = Includes;
      Excludes = SimplifyFilters(Excludes).ToList();

      _includeFilters = Includes.Select(FilterToRegex).ToArray();
      _excludeFilters = Excludes.Select(FilterToRegex).ToArray();
    }

    /// &lt;summary&gt;
    ///   All the includes in the filter.
    /// &lt;/summary&gt;
    public IReadOnlyCollection&lt;string&gt; Includes { get; }

    /// &lt;summary&gt;
    ///   All the excludes in the filter.
    /// &lt;/summary&gt;
    public IReadOnlyCollection&lt;string&gt; Excludes { get; }

    /// &lt;summary&gt;
    /// &lt;see langword=&quot;true&quot; /&gt; if the filter includes all possible files, &lt;see langword=&quot;false&quot; /&gt; otherwise.
    /// &lt;/summary&gt;
    public bool IncludesAll =&gt; Includes.Count == 1 &amp;&amp; Includes.Single() == &quot;*&quot;;

    /// &lt;summary&gt;
    /// Returns &lt;see langword=&quot;true&quot; /&gt; if the given &lt;paramref name=&quot;name&quot;/&gt; matches the filter, &lt;see langword=&quot;false&quot; /&gt; otherwise.
    /// &lt;/summary&gt;
    public bool IsMatch(string name)
    {
      return _includeFilters.Any(f =&gt; f.IsMatch(name)) &amp;&amp; !_excludeFilters.Any(f =&gt; f.IsMatch(name));
    }

    /// &lt;inheritdoc /&gt;
    [SuppressMessage(&quot;Microsoft.Design&quot;, &quot;CA1065:DoNotRaiseExceptionsInUnexpectedLocations&quot;)]
    public override string ToString()
    {
      return string.Join(&quot;;&quot;, Includes.Select(s =&gt; &quot;+&quot; + s).Concat(Excludes.Select(s =&gt; &quot;-&quot; + s)));
    }

    private Regex FilterToRegex(string filter)
    {
      return new Regex($&quot;^{filter.Replace(&quot;.&quot;, &quot;\\.&quot;).Replace(&quot;*&quot;, &quot;.*&quot;)}$&quot;, RegexOptions.None);
    }

    /// &lt;summary&gt;
    ///   Creates a &lt;see cref=&quot;NameFilter&quot; /&gt; from the given &lt;paramref name=&quot;filter&quot; /&gt; containing a &lt;see cref=&quot;string&quot; /&gt; representation of a
    ///   &lt;see cref=&quot;NameFilter&quot; /&gt;.
    /// &lt;/summary&gt;
    public static NameFilter Parse([NotNull] string filter)
    {
      var partRegex = @&quot;((\+?|-)[\w\-.*]+)&quot;;
      var regex = new Regex($&quot;^{partRegex}(;{partRegex})*$&quot;);

      if (!regex.IsMatch(filter))
        throw new FormatException($&quot;The filter string &#39;{filter}&#39; is not in the correct format.&quot;);

      var parts = filter.Split(&#39;;&#39;);

      var includes = new List&lt;string&gt;();
      var excludes = new List&lt;string&gt;();

      foreach (var part in parts)
        if (part[0] == &#39;-&#39;)
          excludes.Add(part.TrimStart(&#39;-&#39;));
        else
          includes.Add(part.TrimStart(&#39;+&#39;));

      return new NameFilter(includes, excludes);
    }

    private IEnumerable&lt;string&gt; SimplifyFilters(IReadOnlyCollection&lt;string&gt; filters)
    {
      filters = filters.Where(s =&gt; !string.IsNullOrWhiteSpace(s)).Select(s =&gt; s_removeDuplicateAsterisksRegex.Replace(s, &quot;*&quot;)).Distinct().ToList();

      var wildCardFilters = filters.Where(f =&gt; f.Contains(&quot;*&quot;)).Select(f =&gt; new { Regex = FilterToRegex(f), Filter = f });

      return wildCardFilters
          .Aggregate(
            filters,
            (current, wildCardFilter) =&gt; current.Where(f =&gt; f == wildCardFilter.Filter || !wildCardFilter.Regex.IsMatch(f)).ToList());
    }

    /// &lt;inheritdoc /&gt;
    public override bool Equals([CanBeNull] object obj)
    {
      return obj is NameFilter other &amp;&amp; ToString().Equals(other.ToString());
    }

    /// &lt;inheritdoc /&gt;
    public override int GetHashCode()
    {
      return ToString().GetHashCode();
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,5,15,110,1],[21,5,21,89,1],[23,7,23,44,1],[25,7,25,79,1],[26,7,26,79,1],[28,7,28,39,1],[29,7,29,53,1],[30,7,30,61,1],[32,7,32,53,1],[33,7,33,31,1],[34,9,34,34,1],[36,7,36,27,1],[37,7,37,53,1],[39,7,39,66,1],[40,7,40,66,1],[56,32,56,79,1],[63,7,63,39,1],[63,39,63,54,1],[63,54,63,85,1],[63,85,63,100,1],[63,100,63,102,1],[63,7,63,102,1],[70,7,70,52,1],[70,52,70,59,1],[70,59,70,89,1],[70,89,70,96,1],[70,96,70,100,1],[70,7,70,100,1],[75,7,75,97,1],[84,7,84,45,1],[85,7,85,62,1],[87,7,87,34,1],[88,9,88,98,1],[90,7,90,37,1],[92,7,92,41,1],[93,7,93,41,1],[95,16,95,24,1],[95,25,95,27,1],[95,28,95,33,1],[96,9,96,28,1],[97,11,97,45,1],[99,11,99,45,1],[101,7,101,49,1],[106,7,106,36,1],[106,36,106,65,1],[106,65,106,79,1],[106,79,106,126,1],[106,126,106,148,1],[106,7,106,148,1],[108,7,108,48,1],[108,48,108,63,1],[108,63,108,77,1],[108,77,108,121,1],[108,121,108,123,1],[108,7,108,123,1],[110,7,113,42,1],[113,42,113,61,1],[113,61,113,123,1],[113,123,113,133,1],[113,42,113,133,1],[113,133,113,135,1],[110,7,113,135,1],[119,7,119,77,1],[125,7,125,39,1]]);
    </script>
  </body>
</html>