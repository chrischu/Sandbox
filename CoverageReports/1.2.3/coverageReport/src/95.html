<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Commons.Console\ConsoleCommandBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Runtime.Serialization;
using JetBrains.Annotations;
using ManyConsole;
using NLog;

namespace SolutionInspector.Commons.Console
{
  [PublicAPI]
  // ReSharper disable once MissingXmlDoc
  public interface IArgumentsBuilderWithSetValues&lt;out TArguments&gt;
  {
    IArgumentsBuilderWithSetValues&lt;TArguments&gt; Option&lt;T&gt; (
        string longKey,
        string shortKey,
        string description,
        Action&lt;TArguments, T&gt; setValue,
        T defaultValue = default(T));

    IArgumentsBuilderWithSetValues&lt;TArguments&gt; Flag (string longKey, string shortKey, string description, Action&lt;TArguments, bool&gt; setValue);
  }

  [PublicAPI]
  // ReSharper disable once MissingXmlDoc
  public interface IArgumentsBuilder&lt;out TArguments&gt;
  {
    IArgumentsBuilder&lt;TArguments&gt; Option&lt;T&gt; (
        string longKey,
        string shortKey,
        string description,
        Action&lt;TArguments, T&gt; setValue,
        T defaultValue = default(T));

    IArgumentsBuilder&lt;TArguments&gt; Flag (string longKey, string shortKey, string description, Action&lt;TArguments, bool&gt; setValue);

    IArgumentsBuilderWithSetValues&lt;TArguments&gt; Values (Action&lt;IValueArgumentsBuilder&lt;TArguments&gt;&gt; configureValueArguments);
  }

  [PublicAPI]
  // ReSharper disable once MissingXmlDoc
  public interface IValueArgumentsBuilder&lt;out TArguments&gt;
  {
    IValueArgumentsBuilder&lt;TArguments&gt; Value (string name, Action&lt;TArguments, string&gt; setValue);
  }

  /// &lt;summary&gt;
  ///   Base class for console commands.
  /// &lt;/summary&gt;
  public abstract class ConsoleCommandBase&lt;TRawArguments, TParsedArguments&gt; : ConsoleCommand
      where TRawArguments : new()
  {
    protected readonly Logger Log = LogManager.GetCurrentClassLogger();

    private readonly ArgumentsBuilder&lt;TRawArguments&gt; _rawArgumentsBuilder;
    private TParsedArguments _parsedArguments;

    [SuppressMessage(&quot;Microsoft.Usage&quot;, &quot;CA2214:DoNotCallOverridableMethodsInConstructors&quot;)]
    protected ConsoleCommandBase (string command, string description)
    {
      IsCommand(command, description);
      SkipsCommandSummaryBeforeRunning();
      _rawArgumentsBuilder = new ArgumentsBuilder&lt;TRawArguments&gt;(this);
      // ReSharper disable once VirtualMemberCallInContructor
      SetupArguments(_rawArgumentsBuilder);
    }

    protected abstract void SetupArguments (IArgumentsBuilder&lt;TRawArguments&gt; argumentsBuilder);

    public sealed override int? OverrideAfterHandlingArgumentsBeforeRun ([NotNull] string[] remainingArguments)
    {
      _rawArgumentsBuilder.HandleRemainingArguments(remainingArguments);

      var rawArguments = GetRawArguments();
      _parsedArguments = ValidateAndParseArguments(rawArguments);

      return base.OverrideAfterHandlingArgumentsBeforeRun(remainingArguments);
    }

    private TRawArguments GetRawArguments ()
    {
      try
      {
        return _rawArgumentsBuilder.Build();
      }
      catch (ArgumentParsingException ex)
      {
        throw ReportArgumentValidationError(ex.Message);
      }
    }

    protected abstract TParsedArguments ValidateAndParseArguments (TRawArguments arguments);

    public sealed override int Run ([NotNull] string[] remainingArguments)
    {
      return Run(_parsedArguments);
    }

    protected abstract int Run (TParsedArguments arguments);

    [MustUseReturnValue(&quot;Returned exception must be thrown&quot;)]
    protected Exception ReportArgumentValidationError (string message, Exception ex = null)
    {
      Trace.Assert(!message.EndsWith(&quot;.&quot;), &quot;Message must not end with a &#39;.&#39;&quot;);

      Log.Error(ex, message);

      return new ConsoleHelpAsException(&quot;&quot;);
    }

    [MustUseReturnValue(&quot;Returned value must be used as exit code&quot;)]
    protected int ReportExecutionError (string message, Exception ex)
    {
      Log.Error(ex, message);
      return ConsoleConstants.ErrorExitCode;
    }

    [MustUseReturnValue(&quot;Returned value must be used as exit code&quot;)]
    protected int ReportAbortion ()
    {
      Log.Info(&quot;Command was aborted&quot;);
      return ConsoleConstants.SuccessExitCode;
    }

    protected void LogInfo (string message)
    {
      Log.Log(LogLevel.Info, message);
    }

    protected void LogDebug (string message)
    {
      Log.Log(LogLevel.Debug, message);
    }

    protected void LogError(string message)
    {
      Log.Log(LogLevel.Error, message);
    }

    protected void LogWarning(string message)
    {
      Log.Log(LogLevel.Warn, message);
    }

    private class ArgumentsBuilder&lt;TArguments&gt; : IArgumentsBuilder&lt;TArguments&gt;, IArgumentsBuilderWithSetValues&lt;TArguments&gt;
        where TArguments : new()
    {
      private readonly TArguments _arguments;
      private readonly ConsoleCommand _command;
      private readonly ValueArgumentsBuilder _valueArgumentsBuilder = new ValueArgumentsBuilder();
      private readonly List&lt;UnparsedArgument&gt; _unparsedArguments = new List&lt;UnparsedArgument&gt;();

      public ArgumentsBuilder (ConsoleCommand command)
      {
        _arguments = new TArguments();
        _command = command;
      }

      public TArguments Build ()
      {
        foreach (var unparsedArgument in _unparsedArguments)
          unparsedArgument.Parse(_arguments);

        return _arguments;
      }

      public IArgumentsBuilder&lt;TArguments&gt; Option&lt;T&gt; (
          string longKey,
          string shortKey,
          string description,
          Action&lt;TArguments, T&gt; setValue,
          T defaultValue = default(T))
      {
        setValue(_arguments, defaultValue);

        var unparsedArgument = new UnparsedArgument(longKey, typeof(T), (args, value) =&gt; setValue(args, (T) value));
        _unparsedArguments.Add(unparsedArgument);
        _command.HasOption&lt;string&gt;($&quot;{shortKey}|{longKey}=&quot;, description, v =&gt; unparsedArgument.SetUnparsedArgumentValue(v));
        return this;
      }

      public IArgumentsBuilder&lt;TArguments&gt; Flag (string longKey, string shortKey, string description, Action&lt;TArguments, bool&gt; setValue)
      {
        _command.HasOption($&quot;{shortKey}|{longKey}&quot;, description, v =&gt; setValue(_arguments, v != null));
        return this;
      }

      public IArgumentsBuilderWithSetValues&lt;TArguments&gt; Values (Action&lt;IValueArgumentsBuilder&lt;TArguments&gt;&gt; configureValueArguments)
      {
        configureValueArguments(_valueArgumentsBuilder);
        _valueArgumentsBuilder.SetupAdditionalArguments(_command);
        return this;
      }

      [ExcludeFromCodeCoverage]
      IArgumentsBuilderWithSetValues&lt;TArguments&gt; IArgumentsBuilderWithSetValues&lt;TArguments&gt;.Option&lt;T&gt; (
          string longKey,
          string shortKey,
          string description,
          Action&lt;TArguments, T&gt; setValue,
          [CanBeNull] T defaultValue)
      {
        return (IArgumentsBuilderWithSetValues&lt;TArguments&gt;) Option(longKey, shortKey, description, setValue);
      }

      [ExcludeFromCodeCoverage]
      IArgumentsBuilderWithSetValues&lt;TArguments&gt; IArgumentsBuilderWithSetValues&lt;TArguments&gt;.Flag (
          string longKey,
          string shortKey,
          string description,
          Action&lt;TArguments, bool&gt; setValue)
      {
        return (IArgumentsBuilderWithSetValues&lt;TArguments&gt;) Flag(longKey, shortKey, description, setValue);
      }

      public void HandleRemainingArguments (string[] remainingArguments)
      {
        _valueArgumentsBuilder.ParseAdditionalArguments(_arguments, remainingArguments);
      }

      private class UnparsedArgument
      {
        private string _unparsedArgument;
        private readonly Type _argumentType;
        private readonly string _argumentLongKey;
        private readonly Action&lt;TArguments, object&gt; _setParsedValue;

        public UnparsedArgument (string argumentLongKey, Type parsedType, Action&lt;TArguments, object&gt; setParsedValue)
        {
          _argumentType = Nullable.GetUnderlyingType(parsedType) ?? parsedType;
          _argumentLongKey = argumentLongKey;
          _setParsedValue = setParsedValue;
        }

        public void SetUnparsedArgumentValue (string unparsedArgument)
        {
          _unparsedArgument = unparsedArgument;
        }

        public void Parse (TArguments arguments)
        {
          if (_unparsedArgument == null)
            return;

          try
          {
            var parsedArgument = TypeDescriptor.GetConverter(_argumentType).ConvertFromString(_unparsedArgument);
            _setParsedValue(arguments, parsedArgument);
          }
          catch (Exception ex)
          {
            throw new ArgumentParsingException($&quot;Invalid value for argument &#39;{_argumentLongKey}&#39;: &#39;{_unparsedArgument}&#39;&quot;, ex);
          }
        }
      }

      private class ValueArgumentsBuilder : IValueArgumentsBuilder&lt;TArguments&gt;
      {
        private readonly List&lt;ValueArgument&gt; _valueArguments = new List&lt;ValueArgument&gt;();

        private string AdditionalArgumentsString =&gt; string.Join(&quot; &quot;, _valueArguments.Select(a =&gt; $&quot;&lt;{a.Name}&gt;&quot;));

        public IValueArgumentsBuilder&lt;TArguments&gt; Value (string name, Action&lt;TArguments, string&gt; setValue)
        {
          _valueArguments.Add(new ValueArgument(name, setValue));
          return this;
        }

        public void SetupAdditionalArguments (ConsoleCommand command)
        {
          command.HasAdditionalArguments(_valueArguments.Count, AdditionalArgumentsString);
        }

        public void ParseAdditionalArguments (TArguments arguments, string[] remainingArguments)
        {
          Trace.Assert(remainingArguments.Length == _valueArguments.Count);

          for (var i = 0; i &lt; remainingArguments.Length; i++)
            _valueArguments[i].SetValueAction(arguments, remainingArguments[i]);
        }

        private class ValueArgument
        {
          public ValueArgument (string name, Action&lt;TArguments, string&gt; setValueAction)
          {
            Name = name;
            SetValueAction = setValueAction;
          }

          public string Name { get; }
          public Action&lt;TArguments, string&gt; SetValueAction { get; }
        }
      }
    }

    [Serializable]
    private class ArgumentParsingException : Exception
    {
      public ArgumentParsingException (string message, Exception innerException)
          : base(message, innerException)
      {
      }

      [ExcludeFromCodeCoverage]
      protected ArgumentParsingException (SerializationInfo info, StreamingContext context)
          : base(info, context)
      {
      }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[57,5,57,72,1],[63,5,63,70,1],[65,7,65,39,1],[66,7,66,42,1],[67,7,67,72,1],[69,7,69,44,1],[76,7,76,73,1],[78,7,78,44,1],[79,7,79,66,1],[81,7,81,79,1],[88,9,88,45,1],[90,7,90,42,1],[92,9,92,57,1],[94,5,94,6,1],[100,7,100,36,1],[108,7,108,79,1],[110,7,110,30,1],[112,7,112,45,1],[118,7,118,30,1],[119,7,119,45,1],[125,7,125,39,1],[126,7,126,47,1],[131,7,131,39,1],[136,7,136,40,1],[141,7,141,40,1],[146,7,146,39,1],[154,7,154,99,1],[155,7,155,97,1],[157,7,157,55,1],[159,9,159,39,1],[160,9,160,28,1],[165,18,165,38,1],[165,39,165,41,1],[165,42,165,60,1],[166,11,166,46,1],[168,9,168,27,1],[178,9,178,44,1],[180,9,180,90,1],[180,90,180,115,1],[180,115,180,117,1],[180,9,180,117,1],[181,9,181,50,1],[182,9,182,80,1],[182,80,182,124,1],[182,124,182,126,1],[182,9,182,126,1],[183,9,183,21,1],[188,9,188,71,1],[188,71,188,102,1],[188,102,188,104,1],[188,9,188,104,1],[189,9,189,21,1],[194,9,194,57,1],[195,9,195,67,1],[196,9,196,21,1],[222,9,222,89,1],[232,9,232,117,1],[234,11,234,80,1],[235,11,235,46,1],[236,11,236,44,1],[241,11,241,48,1],[246,11,246,41,1],[247,13,247,20,1],[251,13,251,114,1],[252,13,252,56,1],[253,11,253,12,1],[254,11,254,31,1],[256,13,256,127,1],[263,9,263,90,1],[265,53,265,98,1],[265,98,265,111,1],[265,111,265,113,1],[265,53,265,113,1],[269,11,269,66,1],[270,11,270,23,1],[275,11,275,92,1],[280,11,280,76,1],[282,16,282,25,1],[282,27,282,56,1],[282,58,282,61,1],[283,13,283,81,1],[288,11,288,88,1],[290,13,290,25,1],[291,13,291,45,1],[304,13,304,42,1]]);
    </script>
  </body>
</html>