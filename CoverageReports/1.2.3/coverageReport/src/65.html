<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Internals\ObjectModel\AdvancedProject.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using JetBrains.Annotations;
using Microsoft.Build.Construction;
using SolutionInspector.Api.ObjectModel;

namespace SolutionInspector.Internals.ObjectModel
{
  internal class AdvancedProject : IAdvancedProject
  {
    public AdvancedProject (Microsoft.Build.Evaluation.Project msBuildProject, ProjectInSolution msBuildProjectInSolution)
    {
      MsBuildProjectInSolution = msBuildProjectInSolution;
      MsBuildProject = msBuildProject;

      Properties = ProcessProperties(MsBuildProject.Xml.Properties);
    }

    public ProjectInSolution MsBuildProjectInSolution { get; }
    public Microsoft.Build.Evaluation.Project MsBuildProject { get; }

    public IReadOnlyDictionary&lt;string, IProjectProperty&gt; Properties { get; }

    public IReadOnlyDictionary&lt;string, IEvaluatedProjectPropertyValue&gt; EvaluateProperties (
      BuildConfiguration configuration,
      Dictionary&lt;string, string&gt; propertyValues = null)
    {
      propertyValues = propertyValues ?? new Dictionary&lt;string, string&gt;();
      propertyValues.Add(&quot;Configuration&quot;, configuration.ConfigurationName);
      propertyValues.Add(&quot;Platform&quot;, configuration.PlatformName);
      return EvaluateProperties(propertyValues);
    }

    public IReadOnlyDictionary&lt;string, IEvaluatedProjectPropertyValue&gt; EvaluateProperties (Dictionary&lt;string, string&gt; propertyValues = null)
    {
      var result = new Dictionary&lt;string, IEvaluatedProjectPropertyValue&gt;();

      using (new MsBuildConditionContext(MsBuildProject, propertyValues))
      {
        foreach (var property in Properties.Values)
        {
          var projectPropertyElement = MsBuildProject.GetProperty(property.Name)?.Xml;
          if (projectPropertyElement != null)
            result.Add(
              property.Name,
              new EvaluatedProjectPropertyValue(projectPropertyElement.Value, new ProjectPropertyOccurrence(projectPropertyElement)));
        }
      }

      return result;
    }

    private IReadOnlyDictionary&lt;string, IProjectProperty&gt; ProcessProperties (IEnumerable&lt;ProjectPropertyElement&gt; propertyElements)
    {
      var result = new Dictionary&lt;string, ProjectProperty&gt;();

      foreach (var propertyElement in propertyElements)
      {
        if (!result.TryGetValue(propertyElement.Name, out var property))
          property = result[propertyElement.Name] = new ProjectProperty(propertyElement.Name, MsBuildProject.GetPropertyValue(propertyElement.Name));

        property.Add(new ProjectPropertyOccurrence(propertyElement));
      }

      return new ReadOnlyDictionary&lt;string, IProjectProperty&gt;(result.ToDictionary(x =&gt; x.Key, x =&gt; (IProjectProperty) x.Value));
    }

    private class MsBuildConditionContext : IDisposable
    {
      private readonly Microsoft.Build.Evaluation.Project _msBuildProject;
      private readonly List&lt;string&gt; _setPropertyNames = new List&lt;string&gt;();

      public MsBuildConditionContext (Microsoft.Build.Evaluation.Project msBuildProject, [CanBeNull] Dictionary&lt;string, string&gt; propertyValues)
      {
        _msBuildProject = msBuildProject;
        if (propertyValues != null)
        {
          foreach (var propertyValue in propertyValues)
          {
            _setPropertyNames.Add(propertyValue.Key);
            _msBuildProject.SetGlobalProperty(propertyValue.Key, propertyValue.Value);
          }
        }

        _msBuildProject.ReevaluateIfNecessary();
      }

      public void Dispose ()
      {
        foreach (var propertyName in _setPropertyNames)
          _msBuildProject.RemoveGlobalProperty(propertyName);

        _msBuildProject.ReevaluateIfNecessary();
      }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[13,5,13,123,1],[15,7,15,59,1],[16,7,16,39,1],[18,7,18,69,1],[30,7,30,75,1],[31,7,31,76,1],[32,7,32,66,1],[33,7,33,49,1],[38,7,38,77,1],[40,7,40,74,1],[42,18,42,30,1],[42,31,42,33,1],[42,34,42,51,1],[44,11,44,87,1],[45,11,45,46,1],[46,13,48,135,1],[52,7,52,21,1],[57,7,57,62,1],[59,16,59,35,1],[59,36,59,38,1],[59,39,59,55,1],[61,9,61,73,1],[62,11,62,150,1],[64,9,64,70,1],[67,7,67,88,1],[67,88,67,93,1],[67,93,67,100,1],[67,100,67,126,1],[67,126,67,129,1],[67,7,67,129,1],[73,7,73,76,1],[75,7,75,144,1],[77,9,77,42,1],[78,9,78,36,1],[80,20,80,37,1],[80,38,80,40,1],[80,41,80,55,1],[82,13,82,54,1],[83,13,83,87,1],[87,9,87,49,1],[92,18,92,34,1],[92,35,92,37,1],[92,38,92,55,1],[93,11,93,62,1],[95,9,95,49,1]]);
    </script>
  </body>
</html>