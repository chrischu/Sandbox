<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector\Commands\InspectCommand.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using JetBrains.Annotations;
using Microsoft.Build.Exceptions;
using SolutionInspector.Api.Configuration;
using SolutionInspector.Api.Configuration.Ruleset;
using SolutionInspector.Api.Exceptions;
using SolutionInspector.Api.ObjectModel;
using SolutionInspector.Api.Reporting;
using SolutionInspector.Api.Rules;
using SolutionInspector.Commons.Console;
using SolutionInspector.Commons.Extensions;
using SolutionInspector.Internals;
using SolutionInspector.Reporting;
using SolutionInspector.Rules;
using SolutionInspector.Utilities;

namespace SolutionInspector.Commands
{
  internal class InspectCommand : ConsoleCommandBase&lt;InspectCommand.RawArguments, InspectCommand.ParsedArguments&gt;
  {
    private readonly ISolutionInspectorConfiguration _configuration;

    private readonly IConfigurationLoader _configurationLoader;
    private readonly IRuleCollectionBuilder _ruleCollectionBuilder;
    private readonly ISolutionLoader _solutionLoader;
    private readonly IViolationReporterFactory _violationReporterFactory;

    public InspectCommand (
        IConfigurationLoader configurationLoader,
        ISolutionLoader solutionLoader,
        IRuleCollectionBuilder ruleCollectionBuilder,
        IViolationReporterFactory violationReporterFactory,
        ISolutionInspectorConfiguration configuration)
        : base(&quot;inspect&quot;, &quot;Inspects a given solution for rule violations.&quot;)
    {
      _configurationLoader = configurationLoader;
      _solutionLoader = solutionLoader;
      _ruleCollectionBuilder = ruleCollectionBuilder;
      _violationReporterFactory = violationReporterFactory;
      _configuration = configuration;
    }

    protected override void SetupArguments (IArgumentsBuilder&lt;RawArguments&gt; argumentsBuilder)
    {
      argumentsBuilder
          .Option&lt;ViolationReportFormat&gt;(
              &quot;reportFormat&quot;,
              &quot;f&quot;,
              $&quot;Controls the format of the violation report ({Enum.GetNames(typeof(ViolationReportFormat)).Join(&quot;|&quot;)}).&quot;,
              (a, v) =&gt; a.ReportFormat = v)
          .Option&lt;string&gt;(
              &quot;reportOutputFile&quot;,
              &quot;o&quot;,
              &quot;Writes the violation report to the given file instead of to the console.&quot;,
              (a, v) =&gt; a.ReportOutputFile = v?.Trim())
          .Option&lt;string&gt;(
              &quot;configurationFile&quot;,
              &quot;c&quot;,
              $&quot;Changes the rule configuration file that is used to the given file path instead of &lt;solutionFilePath&gt;.{SolutionInspectorProgram.RulesetFileExtension}.&quot;,
              (a, v) =&gt; a.ConfigurationFile = v?.Trim()
          )
          .Values(c =&gt; c.Value(&quot;solutionFilePath&quot;, (a, v) =&gt; a.SolutionFilePath = v));
    }

    protected override ParsedArguments ValidateAndParseArguments (RawArguments arguments)
    {
      var configuration = ValidateAndLoadRulesConfiguration(arguments);
      var solution = ValidateAndParseSolution(arguments);
      var rules = _ruleCollectionBuilder.Build(configuration);

      return new ParsedArguments(solution, rules, arguments.ReportFormat, arguments.ReportOutputFile);
    }

    private IRulesetConfiguration ValidateAndLoadRulesConfiguration (RawArguments arguments)
    {
      var configurationFilePath = arguments.ConfigurationFile ?? $&quot;{arguments.SolutionFilePath}.{SolutionInspectorProgram.RulesetFileExtension}&quot;;

      try
      {
        return _configurationLoader.LoadRulesConfig(configurationFilePath);
      }
      catch (FileNotFoundException)
      {
        throw ReportArgumentValidationError($&quot;Could not find configuration file &#39;{configurationFilePath}&#39;&quot;);
      }
      catch (Exception ex)
      {
        throw ReportArgumentValidationError($&quot;Unexpected error when loading configuration file &#39;{configurationFilePath}&#39;&quot;, ex);
      }
    }

    private ISolution ValidateAndParseSolution (RawArguments arguments)
    {
      try
      {
        return _solutionLoader.Load(arguments.SolutionFilePath, _configuration.MsBuildParsing);
      }
      catch (SolutionNotFoundException)
      {
        throw ReportArgumentValidationError($&quot;Given solution file &#39;{arguments.SolutionFilePath}&#39; could not be found&quot;);
      }
      catch (InvalidProjectFileException ex)
      {
        throw ReportArgumentValidationError($&quot;Given solution file &#39;{arguments.SolutionFilePath}&#39; contains an invalid project file &#39;{ex.ProjectFile}&#39;&quot;);
      }
      catch (Exception ex)
      {
        throw ReportArgumentValidationError($&quot;Unexpected error when loading solution file &#39;{arguments.SolutionFilePath}&#39;&quot;, ex);
      }
    }

    protected override int Run (ParsedArguments arguments)
    {
      using (var solution = arguments.Solution)
      {
        LogInfo($&quot;Inspecting solution &#39;{solution.FullPath}&#39;...&quot;);

        var violations = GetRuleViolations(solution, arguments.Rules).ToArray();

        if (violations.Any())
        {
          using (var reporter = CreateViolationReporter(arguments))
          {
            reporter.Report(violations);
          }

          return 1;
        }

        return 0;
      }
    }

    private IViolationReporter CreateViolationReporter (ParsedArguments arguments)
    {
      if (arguments.ReportOutputFile != null)
        return _violationReporterFactory.CreateFileReporter(arguments.ReportFormat, arguments.ReportOutputFile);

      return _violationReporterFactory.CreateConsoleReporter(arguments.ReportFormat);
    }

    private IEnumerable&lt;IRuleViolation&gt; GetRuleViolations (ISolution solution, IRuleCollection rules)
    {
      var ruleViolations = new List&lt;IRuleViolation&gt;();
      var previousViolationCount = 0;

      LogInfo($&quot;Checking for solution rule violations in solution &#39;{solution.FullPath}&#39;...&quot;);
      foreach (var solutionRule in rules.SolutionRules)
        ruleViolations.AddRange(solutionRule.Evaluate(solution));
      LogInfo(
          $&quot;Finished checking for solution rule violations in solution &#39;{solution.FullPath}&#39;: &quot; +
          $&quot;Found {ruleViolations.Count - previousViolationCount} violations.&quot;);

      foreach (var project in solution.Projects)
      {
        LogInfo($&quot;Checking for project rule violations in project &#39;{project.FullPath}&#39;...&quot;);
        previousViolationCount = ruleViolations.Count;
        foreach (var projectRule in rules.ProjectRules)
          ruleViolations.AddRange(projectRule.Evaluate(project));
        LogInfo(
            $&quot;Finished checking for project rule violations in project &#39;{project.FullPath}&#39;: &quot; +
            $&quot;Found {ruleViolations.Count - previousViolationCount} violations.&quot;);
      }

      foreach (var project in solution.Projects)
      {
        LogInfo($&quot;Checking for project item rule violations in project &#39;{project.FullPath}&#39;...&quot;);
        previousViolationCount = ruleViolations.Count;

        foreach (var projectItem in project.ProjectItems)
        {
          LogDebug($&quot;Checking for project item rule violations in project item &#39;{projectItem.FullPath}&#39;...&quot;);
          foreach (var projectItemRule in rules.ProjectItemRules)
            ruleViolations.AddRange(projectItemRule.Evaluate(projectItem));
        }

        LogInfo(
            $&quot;Finished checking for project item rule violations in project &#39;{project.FullPath}&#39;: &quot; +
            $&quot;Found {ruleViolations.Count - previousViolationCount} violations.&quot;);
      }

      LogInfo(
          $&quot;Finished checking for violations in solution &#39;{solution.FullPath}&#39;: &quot; +
          $&quot;Found {ruleViolations.Count} total violations.&quot;);
      return ruleViolations;
    }

    public class RawArguments
    {
      public string SolutionFilePath { get; set; }
      public ViolationReportFormat ReportFormat { get; set; }
      public string ReportOutputFile { get; set; }
      public string ConfigurationFile { get; set; }
    }

    public class ParsedArguments
    {
      public ParsedArguments (
          ISolution solution,
          IRuleCollection rules,
          ViolationReportFormat reportFormat,
          [CanBeNull] string reportOutputFile)
      {
        Solution = solution;
        Rules = rules;
        ReportFormat = reportFormat;
        ReportOutputFile = reportOutputFile;
      }

      public ISolution Solution { get; }
      public IRuleCollection Rules { get; }
      public ViolationReportFormat ReportFormat { get; }

      [CanBeNull]
      public string ReportOutputFile { get; }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[37,11,37,76,1],[39,7,39,50,1],[40,7,40,40,1],[41,7,41,54,1],[42,7,42,60,1],[43,7,43,38,1],[48,7,53,25,1],[53,25,53,43,1],[53,43,58,25,1],[58,25,58,55,1],[58,55,63,25,1],[63,25,63,56,1],[63,56,65,24,1],[65,24,65,62,1],[65,62,65,84,1],[65,84,65,85,1],[65,24,65,85,1],[65,85,65,87,1],[48,7,65,87,1],[70,7,70,72,1],[71,7,71,58,1],[72,7,72,63,1],[74,7,74,103,1],[79,7,79,146,1],[83,9,83,76,1],[85,7,85,36,1],[87,9,87,109,1],[89,7,89,27,1],[91,9,91,128,1],[93,5,93,6,1],[99,9,99,96,1],[101,7,101,40,1],[103,9,103,119,1],[105,7,105,45,1],[107,9,107,152,1],[109,7,109,27,1],[111,9,111,128,1],[113,5,113,6,1],[117,14,117,47,1],[119,9,119,66,1],[121,9,121,81,1],[123,9,123,30,1],[125,18,125,67,1],[127,13,127,41,1],[128,11,128,12,1],[130,11,130,20,1],[133,9,133,18,1],[135,5,135,6,1],[139,7,139,46,1],[140,9,140,113,1],[142,7,142,86,1],[147,7,147,55,1],[148,7,148,38,1],[150,7,150,94,1],[151,16,151,32,1],[151,33,151,35,1],[151,36,151,55,1],[152,9,152,66,1],[153,7,155,81,1],[157,16,157,27,1],[157,28,157,30,1],[157,31,157,48,1],[159,9,159,93,1],[160,9,160,55,1],[161,18,161,33,1],[161,34,161,36,1],[161,37,161,55,1],[162,11,162,66,1],[163,9,165,83,1],[168,16,168,27,1],[168,28,168,30,1],[168,31,168,48,1],[170,9,170,98,1],[171,9,171,55,1],[173,18,173,33,1],[173,34,173,36,1],[173,37,173,57,1],[175,11,175,110,1],[176,20,176,39,1],[176,40,176,42,1],[176,43,176,65,1],[177,13,177,76,1],[180,9,182,83,1],[185,7,187,62,1],[188,7,188,29,1],[201,7,205,47,1],[207,9,207,29,1],[208,9,208,23,1],[209,9,209,37,1],[210,9,210,45,1]]);
    </script>
  </body>
</html>