<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Configuration\Validation\ValidatingConfigurationVisitor.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Reflection;
using System.Xml.Linq;
using JetBrains.Annotations;
using SolutionInspector.Commons.Extensions;
using SolutionInspector.Configuration.Attributes;
using SolutionInspector.Configuration.Validation.Dynamic;
using SolutionInspector.Configuration.Validation.Static;

namespace SolutionInspector.Configuration.Validation
{
  internal class ValidatingConfigurationVisitor : IStaticConfigurationVisitor, IDynamicConfigurationVisitor
  {
    private readonly Dictionary&lt;Type, Dictionary&lt;PropertyInfo, List&lt;string&gt;&gt;&gt; _cachedStaticValidationErrorsByType =
        new Dictionary&lt;Type, Dictionary&lt;PropertyInfo, List&lt;string&gt;&gt;&gt;();

    private readonly IReadOnlyCollection&lt;IDynamicConfigurationValidator&gt; _dynamicValidators;
    private readonly IConfigurationValidationErrorCollector _errorCollector;
    private readonly IReadOnlyCollection&lt;IStaticConfigurationValidator&gt; _staticValidators;

    private bool _disableValidation;

    public ValidatingConfigurationVisitor (
      IConfigurationValidationErrorCollector errorCollector,
      IReadOnlyCollection&lt;IStaticConfigurationValidator&gt; staticValidators,
      IReadOnlyCollection&lt;IDynamicConfigurationValidator&gt; dynamicValidators
    )
    {
      _errorCollector = errorCollector;
      _staticValidators = staticValidators;
      _dynamicValidators = dynamicValidators;
    }

    private string BuildPropertyPath (string previousPropertyPath, PropertyInfo property)
    {
      if (string.IsNullOrEmpty(previousPropertyPath))
        return property.Name;
      return previousPropertyPath + &quot;.&quot; + property.Name;
    }

    #region Static

    public void BeginTypeVisit (string propertyPath, Type configurationElementType)
    {
      if (_cachedStaticValidationErrorsByType.TryGetValue(configurationElementType, out var typeValidationErrors))
      {
        _disableValidation = true;

        foreach (var propertyValidationErrors in typeValidationErrors)
        {
          var newPropertyPath = BuildPropertyPath(propertyPath, propertyValidationErrors.Key);

          foreach (var messages in propertyValidationErrors.Value)
            _errorCollector.AddPropertyError(newPropertyPath, messages);
        }
      }
      else
      {
        foreach (var configurationValidator in _staticValidators)
          configurationValidator.BeginTypeValidation(
            configurationElementType,
            (prop, msg) =&gt; ReportStaticValidationError(BuildPropertyPath(propertyPath, prop), prop, msg));
      }
    }

    public void VisitValue (string propertyPath, PropertyInfo property, ConfigurationValueAttribute attribute)
    {
      if (!_disableValidation)
        foreach (var configurationValidator in _staticValidators)
          configurationValidator.ValidateValue(property, attribute, (prop, msg) =&gt; ReportStaticValidationError(propertyPath, prop, msg));
    }

    public void VisitSubelement (string propertyPath, PropertyInfo property, ConfigurationSubelementAttribute attribute)
    {
      if (!_disableValidation)
        foreach (var configurationValidator in _staticValidators)
          configurationValidator.ValidateSubelement(property, attribute, (prop, msg) =&gt; ReportStaticValidationError(propertyPath, prop, msg));
    }

    public void VisitCollection (string propertyPath, PropertyInfo property, ConfigurationCollectionAttribute attribute)
    {
      if (!_disableValidation)
        foreach (var configurationValidator in _staticValidators)
          configurationValidator.ValidateCollection(property, attribute, (prop, msg) =&gt; ReportStaticValidationError(propertyPath, prop, msg));
    }

    public void VisitDynamicCollection (string propertyPath, PropertyInfo property, DynamicConfigurationCollectionAttribute attribute)
    {
      if (!_disableValidation)
        foreach (var configurationValidator in _staticValidators)
          configurationValidator.ValidateDynamicCollection(property, attribute, (prop, msg) =&gt; ReportStaticValidationError(propertyPath, prop, msg));
    }

    public void EndTypeVisit (string propertyPath, Type configurationElementType)
    {
      if (!_disableValidation)
        foreach (var configurationValidator in _staticValidators)
          configurationValidator.EndTypeValidation(
            configurationElementType,
            (prop, msg) =&gt; ReportStaticValidationError(BuildPropertyPath(propertyPath, prop), prop, msg));

      _disableValidation = false;
    }

    private void ReportStaticValidationError (string propertyPath, PropertyInfo property, string message)
    {
      var validationErrorsForType = _cachedStaticValidationErrorsByType.GetOrAdd(
        property.DeclaringType.AssertNotNull(),
        key =&gt; new Dictionary&lt;PropertyInfo, List&lt;string&gt;&gt;());
      var validationErrorsForProperty = validationErrorsForType.GetOrAdd(property, key =&gt; new List&lt;string&gt;());
      validationErrorsForProperty.Add(message);

      _errorCollector.AddPropertyError(propertyPath, message);
    }

    #endregion

    #region Dynamic

    public void BeginTypeVisit (string propertyPath, Type configurationElementType, XElement element)
    {
      foreach (var configurationValidator in _dynamicValidators)
        configurationValidator.BeginTypeValidation(
          configurationElementType,
          element,
          (prop, msg) =&gt; ReportDynamicValidationError(BuildPropertyPath(propertyPath, prop), msg));
    }

    public void VisitValue (string propertyPath, PropertyInfo property, ConfigurationValueAttribute attribute, [CanBeNull] XAttribute xAttribute)
    {
      foreach (var configurationValidator in _dynamicValidators)
        configurationValidator.ValidateValue(property, attribute, xAttribute, (prop, msg) =&gt; ReportDynamicValidationError(propertyPath, msg));
    }

    public void VisitSubelement (
      string propertyPath,
      PropertyInfo property,
      ConfigurationSubelementAttribute attribute,
      [CanBeNull] XElement subelement)
    {
      foreach (var configurationValidator in _dynamicValidators)
        configurationValidator.ValidateSubelement(property, attribute, subelement, (prop, msg) =&gt; ReportDynamicValidationError(propertyPath, msg));
    }

    public void VisitCollection (
      string propertyPath,
      PropertyInfo property,
      ConfigurationCollectionAttribute attribute,
      [CanBeNull] XElement collectionElement,
      [CanBeNull] IReadOnlyCollection&lt;XElement&gt; collectionItems)
    {
      foreach (var configurationValidator in _dynamicValidators)
      {
        configurationValidator.ValidateCollection(
          property,
          attribute,
          collectionElement,
          collectionItems,
          (prop, msg) =&gt; ReportDynamicValidationError(propertyPath, msg));
      }
    }

    public void VisitDynamicCollection (
        string propertyPath,
        PropertyInfo property,
        DynamicConfigurationCollectionAttribute attribute,
        [CanBeNull] XElement collectionElement,
        [CanBeNull] IReadOnlyCollection&lt;XElement&gt; collectionItems)
    {
      foreach (var configurationValidator in _dynamicValidators)
      {
        configurationValidator.ValidateDynamicCollection(
            property,
            attribute,
            collectionElement,
            collectionItems,
            (prop, msg) =&gt; ReportDynamicValidationError(propertyPath, msg));
      }
    }

    public void EndTypeVisit (string propertyPath, Type configurationElementType, XElement element)
    {
      foreach (var configurationValidator in _dynamicValidators)
      {
        configurationValidator.EndTypeValidation(
          configurationElementType,
          element,
          (prop, msg) =&gt; ReportDynamicValidationError(BuildPropertyPath(propertyPath, prop), msg));
      }
    }

    private void ReportDynamicValidationError (string propertyPath, string message)
    {
      _errorCollector.AddPropertyError(propertyPath, message);
    }

    #endregion
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[15,5,16,72,1],[24,5,28,6,1],[30,7,30,40,1],[31,7,31,44,1],[32,7,32,46,1],[37,7,37,54,1],[38,9,38,30,1],[39,7,39,57,1],[46,7,46,115,1],[48,9,48,35,1],[50,18,50,46,1],[50,47,50,49,1],[50,50,50,70,1],[52,11,52,95,1],[54,20,54,32,1],[54,33,54,35,1],[54,36,54,66,1],[55,13,55,73,1],[60,18,60,44,1],[60,45,60,47,1],[60,48,60,65,1],[61,11,63,28,1],[63,28,63,105,1],[63,105,63,107,1],[61,11,63,107,1],[69,7,69,31,1],[70,18,70,44,1],[70,45,70,47,1],[70,48,70,65,1],[71,11,71,84,1],[71,84,71,136,1],[71,136,71,138,1],[71,11,71,138,1],[76,7,76,31,1],[77,18,77,44,1],[77,45,77,47,1],[77,48,77,65,1],[78,11,78,89,1],[78,89,78,141,1],[78,141,78,143,1],[78,11,78,143,1],[83,7,83,31,1],[84,18,84,44,1],[84,45,84,47,1],[84,48,84,65,1],[85,11,85,89,1],[85,89,85,141,1],[85,141,85,143,1],[85,11,85,143,1],[90,7,90,31,1],[91,18,91,44,1],[91,45,91,47,1],[91,48,91,65,1],[92,11,92,96,1],[92,96,92,148,1],[92,148,92,150,1],[92,11,92,150,1],[97,7,97,31,1],[98,18,98,44,1],[98,45,98,47,1],[98,48,98,65,1],[99,11,101,28,1],[101,28,101,105,1],[101,105,101,107,1],[99,11,101,107,1],[103,7,103,34,1],[108,7,110,16,1],[110,16,110,60,1],[110,60,110,62,1],[108,7,110,62,1],[111,7,111,91,1],[111,91,111,109,1],[111,109,111,111,1],[111,7,111,111,1],[112,7,112,48,1],[114,7,114,63,1],[123,16,123,42,1],[123,43,123,45,1],[123,46,123,64,1],[124,9,127,26,1],[127,26,127,98,1],[127,98,127,100,1],[124,9,127,100,1],[132,16,132,42,1],[132,43,132,45,1],[132,46,132,64,1],[133,9,133,94,1],[133,94,133,141,1],[133,141,133,143,1],[133,9,133,143,1],[142,16,142,42,1],[142,43,142,45,1],[142,46,142,64,1],[143,9,143,99,1],[143,99,143,146,1],[143,146,143,148,1],[143,9,143,148,1],[153,16,153,42,1],[153,43,153,45,1],[153,46,153,64,1],[155,9,160,26,1],[160,26,160,73,1],[160,73,160,75,1],[155,9,160,75,1],[171,16,171,42,1],[171,43,171,45,1],[171,46,171,64,1],[173,9,178,28,1],[178,28,178,75,1],[178,75,178,77,1],[173,9,178,77,1],[184,16,184,42,1],[184,43,184,45,1],[184,46,184,64,1],[186,9,189,26,1],[189,26,189,98,1],[189,98,189,100,1],[186,9,189,100,1],[195,7,195,63,1]]);
    </script>
  </body>
</html>