<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Configuration\Validation\Dynamic\DynamicConfigurationTypeWalker.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using System.Xml;
using System.Xml.Linq;
using JetBrains.Annotations;
using SolutionInspector.Configuration.Attributes;

namespace SolutionInspector.Configuration.Validation.Dynamic
{
  internal class DynamicConfigurationTypeWalker
  {
    public void Walk (Type configurationElementType, XElement element, IDynamicConfigurationVisitor visitor)
    {
      WalkInternal(configurationElementType, element, visitor, &quot;&quot;);
    }

    private void WalkInternal (
      Type configurationElementType,
      XElement element,
      IDynamicConfigurationVisitor visitor,
      string propertyPath)
    {
      visitor.BeginTypeVisit(propertyPath, configurationElementType, element);

      var subTypesToWalk = new List&lt;Tuple&lt;string, Type, XElement&gt;&gt;();

      foreach (var property in configurationElementType.GetProperties())
      {
        var newPropertyPath = BuildPropertyPath(propertyPath, property);

        var configurationPropertyAttribute = property.GetCustomAttributes&lt;ConfigurationPropertyAttribute&gt;().ToArray();

        if (configurationPropertyAttribute.Length == 0)
          continue;

        if (configurationPropertyAttribute[0] is ConfigurationValueAttribute configurationValueAttribute)
        {
          if (TryGetAttribute(element, configurationValueAttribute.GetXmlName(property.Name), out var attribute))
            visitor.VisitValue(newPropertyPath, property, configurationValueAttribute, attribute);

          continue;
        }

        if (configurationPropertyAttribute[0] is ConfigurationSubelementAttribute configurationSubelementAttribute)
        {
          if (TryGetSubelement(element, configurationSubelementAttribute.GetXmlName(property.Name), out var subelement))
          {
            if (subelement != null)
              subTypesToWalk.Add(Tuple.Create(newPropertyPath, configurationSubelementAttribute.GetSubelementType(property), subelement));

            visitor.VisitSubelement(newPropertyPath, property, configurationSubelementAttribute, subelement);
          }

          continue;
        }

        if (configurationPropertyAttribute[0] is ConfigurationCollectionAttribute configurationCollectionAttribute)
        {
          if (TryGetCollectionElement(element, configurationCollectionAttribute.GetXmlName(property.Name), out var collectionElement))
          {
            if (TryGetCollectionItems(collectionElement, configurationCollectionAttribute.ElementName, out var collectionItems))
            {
              var collectionElementType = configurationCollectionAttribute.GetCollectionElementType(property);

              if (collectionElementType != null &amp;&amp; collectionElement != null &amp;&amp; collectionItems != null)
              {
                for (var i = 0; i &lt; collectionItems.Count; i++)
                  subTypesToWalk.Add(Tuple.Create($&quot;{newPropertyPath}[{i}]&quot;, collectionElementType, collectionItems[i]));
              }

              visitor.VisitCollection(newPropertyPath, property, configurationCollectionAttribute, collectionElement, collectionItems);
            }
          }
        }

        if (configurationPropertyAttribute[0] is DynamicConfigurationCollectionAttribute dynamicConfigurationCollectionAttribute)
        {
          if (TryGetCollectionElement(element, dynamicConfigurationCollectionAttribute.GetXmlName(property.Name), out var collectionElement))
          {
            var collectionItems = collectionElement?.Elements().ToList();
            visitor.VisitDynamicCollection(newPropertyPath, property, dynamicConfigurationCollectionAttribute, collectionElement, collectionItems);
          }
        }
      }

      visitor.EndTypeVisit(propertyPath, configurationElementType, element);

      foreach (var subTypeToWalk in subTypesToWalk)
        WalkInternal(subTypeToWalk.Item2, subTypeToWalk.Item3, visitor, subTypeToWalk.Item1);
    }

    private bool TryGetAttribute (XElement element, string attributeName, [CanBeNull] out XAttribute attribute)
    {
      try
      {
        attribute = element.Attribute(attributeName);
        return true;
      }
      catch (XmlException)
      {
        // Invalid name =&gt; no need to walk further
        attribute = null;
        return false;
      }
    }

    private bool TryGetSubelement (XElement element, string subelementName, [CanBeNull] out XElement subelement)
    {
      try
      {
        subelement = element.Element(subelementName);
        return true;
      }
      catch (XmlException)
      {
        // Invalid name =&gt; no need to walk further
        subelement = null;
        return false;
      }
    }

    private bool TryGetCollectionElement(XElement element, [CanBeNull] string collectionElementName, [CanBeNull] out XElement collectionElement)
    {
      try
      {
        collectionElement = collectionElementName == null ? element : element.Element(collectionElementName);
        return true;
      }
      catch (XmlException)
      {
        // Invalid name =&gt; no need to walk further
        collectionElement = null;
        return false;
      }
    }

    private bool TryGetCollectionItems (
      [CanBeNull] XElement element,
      string itemName,
      [CanBeNull] out IReadOnlyList&lt;XElement&gt; subelements)
    {
      try
      {
        subelements = element?.Elements(itemName).ToList();
        return true;
      }
      catch (XmlException)
      {
        // Invalid name =&gt; no need to walk further
        subelements = null;
        return false;
      }
    }

    private string BuildPropertyPath (string previousPropertyPath, PropertyInfo property)
    {
      if (string.IsNullOrEmpty(previousPropertyPath))
        return property.Name;
      return previousPropertyPath + &quot;.&quot; + property.Name;
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[16,7,16,68,1],[25,7,25,79,1],[27,7,27,70,1],[29,16,29,28,1],[29,29,29,31,1],[29,32,29,72,1],[31,9,31,73,1],[33,9,33,119,1],[35,9,35,56,1],[38,9,38,106,1],[40,11,40,114,1],[41,13,41,99,1],[43,11,43,20,1],[46,9,46,116,1],[48,11,48,121,1],[50,13,50,36,1],[51,15,51,139,1],[53,13,53,110,1],[56,11,56,20,1],[59,9,59,116,1],[61,11,61,135,1],[63,13,63,129,1],[65,15,65,111,1],[67,15,67,105,1],[69,22,69,31,1],[69,33,69,58,1],[69,60,69,63,1],[70,19,70,122,1],[73,15,73,136,1],[78,9,78,130,1],[80,11,80,142,1],[82,13,82,74,1],[83,13,83,148,1],[88,7,88,77,1],[90,16,90,33,1],[90,34,90,36,1],[90,37,90,51,1],[91,9,91,94,1],[98,9,98,54,1],[99,9,99,21,1],[101,7,101,27,1],[104,9,104,26,1],[105,9,105,22,1],[107,5,107,6,1],[113,9,113,54,1],[114,9,114,21,1],[116,7,116,27,1],[119,9,119,27,1],[120,9,120,22,1],[122,5,122,6,1],[128,9,128,110,1],[129,9,129,21,1],[131,7,131,27,1],[134,9,134,34,1],[135,9,135,22,1],[137,5,137,6,1],[146,9,146,60,1],[147,9,147,21,1],[149,7,149,27,1],[152,9,152,28,1],[153,9,153,22,1],[155,5,155,6,1],[159,7,159,54,1],[160,9,160,30,1],[161,7,161,57,1]]);
    </script>
  </body>
</html>