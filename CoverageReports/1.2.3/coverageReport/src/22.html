<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Configuration\ConfigurationBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Linq;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Xml.Linq;
using Fasterflect;
using JetBrains.Annotations;
using SolutionInspector.Commons.Extensions;
using SolutionInspector.Configuration.Attributes;
using SolutionInspector.Configuration.Collections;
using SolutionInspector.Configuration.Dynamic;
using SolutionInspector.Configuration.Validation;
using Wrapperator.Wrappers;

namespace SolutionInspector.Configuration
{
  /// &lt;summary&gt;
  ///   Base class for configuration classes.
  /// &lt;/summary&gt;
  public abstract class ConfigurationBase
  {
    public static IDynamicConfigurationElementTypeHelper DynamicConfigurationElementTypeHelper { get; set; } =
      new DynamicConfigurationElementTypeHelper(new SchemaLocationHelper(), Wrapper.Assembly);

    /// &lt;summary&gt;
    ///   The underlying &lt;see cref=&quot;XElement&quot; /&gt;.
    /// &lt;/summary&gt;
    public XElement Element { get; private set; }

    internal static T Load&lt;T&gt; (XElement element, Action&lt;T&gt; modifyBeforeValidation = null)
        where T : ConfigurationBase, new()
    {
      return (T) Load(typeof(T), element, c =&gt; modifyBeforeValidation?.Invoke((T) c));
    }

    internal static ConfigurationBase Create (XName elementName, Type configurationType)
    {
      var instance = (ConfigurationBase) Activator.CreateInstance(configurationType);
      instance.Element = new XElement(elementName);
      return instance;
    }

    internal static ConfigurationBase Load (Type configurationType, XElement element, Action&lt;ConfigurationBase&gt; modifyBeforeValidation = null)
    {
      var instance = (ConfigurationBase) Activator.CreateInstance(configurationType);
      instance.Element = element;
      modifyBeforeValidation?.Invoke(instance);
      ConfigurationValidator.Validate(instance);
      return instance;
    }

    /// &lt;summary&gt;
    ///   Gets the configuration subelement represented by the CLR property this method is called from.
    /// &lt;/summary&gt;
    protected T GetConfigurationSubelement&lt;T&gt; ([CallerMemberName] string clrPropertyName = null) where T : ConfigurationElement
    {
      var configurationPropertyAttribute = GetConfigurationPropertyAttribute&lt;ConfigurationSubelementAttribute&gt;(clrPropertyName.AssertNotNull());

      if (configurationPropertyAttribute == null)
        throw new InvalidOperationException($&quot;Property &#39;{clrPropertyName}&#39; is not properly marked as a configuration Subelement.&quot;);

      var elementName = configurationPropertyAttribute.GetXmlName(clrPropertyName);

      var element = Element.Element(elementName);
      if (element == null)
        Element.Add(element = new XElement(elementName));

      return (T) ConfigurationElement.Load(typeof(T), element);
    }

    /// &lt;summary&gt;
    ///   Gets the configuration value represented by the CLR property this method is called from.
    /// &lt;/summary&gt;
    [CanBeNull]
    protected T GetConfigurationValue&lt;T&gt; ([CallerMemberName] string clrPropertyName = null)
    {
      var configurationValueType = typeof(T);
      var configurationValueAttribute = GetConfigurationPropertyAttribute&lt;ConfigurationValueAttribute&gt;(clrPropertyName.AssertNotNull());

      if (configurationValueAttribute == null)
        throw new InvalidOperationException($&quot;Property &#39;{clrPropertyName}&#39; is not properly marked as a configuration property.&quot;);

      var attributeName = configurationValueAttribute.GetXmlName(clrPropertyName);
      var attribute = Element.Attribute(attributeName);

      var configurationConverterAttribute = configurationValueType.GetCustomAttribute&lt;ConfigurationConverterAttribute&gt;();
      if (configurationValueAttribute.ConfigurationConverter != null || configurationConverterAttribute != null)
      {
        if (attribute == null &amp;&amp; configurationValueAttribute.DefaultValue != null)
          Element.Add(attribute = new XAttribute(attributeName, configurationValueAttribute.DefaultValue));

        var converterType = configurationValueAttribute.ConfigurationConverter ?? configurationConverterAttribute.ConfigurationConverterType;
        var converter = CreateConfigurationConverter&lt;T&gt;(converterType);

        return converter.ConvertFrom(attribute?.Value);
      }

      if (typeof(IConfigurationValue).IsAssignableFrom(configurationValueType))
      {
        if (attribute?.Value == null)
          Element.Add(attribute = new XAttribute(attributeName, configurationValueAttribute.DefaultValue ?? &quot;&quot;));

        var instance = (T) Activator.CreateInstance(
          configurationValueType,
          (Action&lt;string&gt;) (s =&gt; Element.SetAttributeValue(attributeName, s)));
        instance.CallMethod(&quot;Deserialize&quot;, attribute.Value);
        return instance;
      }

      if (attribute == null &amp;&amp; configurationValueAttribute.DefaultValue != null)
        Element.Add(attribute = new XAttribute(attributeName, configurationValueAttribute.DefaultValue));

      return (T) Convert.ChangeType(attribute?.Value, configurationValueType);
    }

    private IConfigurationConverter&lt;T&gt; CreateConfigurationConverter&lt;T&gt; (Type configurationConverterType)
    {
      return (IConfigurationConverter&lt;T&gt;) Activator.CreateInstance(configurationConverterType);
    }

    /// &lt;summary&gt;
    ///   Set the configuration value represented by the CLR property this method is called from.
    /// &lt;/summary&gt;
    protected void SetConfigurationValue&lt;T&gt; (T value, [CallerMemberName] string clrPropertyName = null)
    {
      var configurationValue = value as IConfigurationValue;
      var configurationPropertyAttribute = GetConfigurationPropertyAttribute&lt;ConfigurationValueAttribute&gt;(clrPropertyName.AssertNotNull());
      var configurationConverterAttribute = typeof(T).GetCustomAttribute&lt;ConfigurationConverterAttribute&gt;();

      if (configurationPropertyAttribute == null)
        throw new InvalidOperationException($&quot;Property &#39;{clrPropertyName}&#39; is not properly marked as a configuration property.&quot;);

      var attributeName = configurationPropertyAttribute.GetXmlName(clrPropertyName);

      if (configurationValue != null)
      {
        Element.SetAttributeValue(attributeName, configurationValue.Serialize());
      }
      else if (configurationPropertyAttribute.ConfigurationConverter != null || configurationConverterAttribute != null)
      {
        var converterType = configurationPropertyAttribute.ConfigurationConverter ?? configurationConverterAttribute.ConfigurationConverterType;
        var converter = CreateConfigurationConverter&lt;T&gt;(converterType);

        Element.SetAttributeValue(attributeName, converter.ConvertTo(value));
      }
      else
      {
        Element.SetAttributeValue(attributeName, value);
      }
    }

    /// &lt;summary&gt;
    ///   Gets the configuration collection represented by the CLR property this method is called from.
    /// &lt;/summary&gt;
    protected IConfigurationElementCollection&lt;T&gt; GetConfigurationCollection&lt;T&gt; ([CallerMemberName] string clrPropertyName = null)
      where T : ConfigurationElement, new()
    {
      var configurationCollectionAttribute = GetConfigurationPropertyAttribute&lt;ConfigurationCollectionAttribute&gt;(clrPropertyName.AssertNotNull());

      if (configurationCollectionAttribute == null)
        throw new InvalidOperationException($&quot;Property &#39;{clrPropertyName}&#39; is not properly marked as a configuration collection.&quot;);

      XElement collectionElement;
      if (configurationCollectionAttribute.IsDefaultCollection)
      {
        collectionElement = Element;
      }
      else
      {
        collectionElement = Element.Element(configurationCollectionAttribute.GetXmlName(clrPropertyName));

        if (collectionElement == null)
          Element.Add(collectionElement = new XElement(configurationCollectionAttribute.GetXmlName(clrPropertyName).AssertNotNull()));
      }

      var collectionItems = collectionElement.Elements(configurationCollectionAttribute.ElementName).Select(element =&gt; Load&lt;T&gt;(element));
      return new ConfigurationElementCollection&lt;T&gt;(collectionElement, configurationCollectionAttribute.ElementName, collectionItems);
    }

    protected IDynamicConfigurationElementCollection&lt;T&gt; GetDynamicConfigurationCollection&lt;T&gt;([CallerMemberName] string clrPropertyName = null)
      where T : ConfigurationElement
    {
      var configurationCollectionAttribute = GetConfigurationPropertyAttribute&lt;DynamicConfigurationCollectionAttribute&gt;(clrPropertyName.AssertNotNull());

      if (configurationCollectionAttribute == null)
        throw new InvalidOperationException($&quot;Property &#39;{clrPropertyName}&#39; is not properly marked as a dynamic configuration collection.&quot;);

      var collectionElement = configurationCollectionAttribute.IsDefaultCollection
          ? Element
          : Element.Element(configurationCollectionAttribute.GetXmlName(clrPropertyName));
      if (collectionElement == null)
        Element.Add(collectionElement = new XElement(configurationCollectionAttribute.GetXmlName(clrPropertyName).AssertNotNull()));

      var collectionItems = collectionElement.Elements().Select(e =&gt;
      {
        var elementType = DynamicConfigurationElementTypeHelper.ResolveElementType(e);
        return (T) Load(elementType, e);
      });

      return new DynamicConfigurationElementCollection&lt;T&gt;(collectionElement, collectionItems);
    }

    [CanBeNull]
    private T GetConfigurationPropertyAttribute&lt;T&gt; (string clrPropertyName) where T : Attribute
    {
      var type = GetType();
      var property = type.GetProperty(clrPropertyName).AssertNotNull();
      return property.GetCustomAttribute&lt;T&gt;();
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,7,23,94,1],[33,7,33,48,1],[33,48,33,85,1],[33,85,33,87,1],[33,7,33,87,1],[38,7,38,86,1],[39,7,39,52,1],[40,7,40,23,1],[45,7,45,86,1],[46,7,46,34,1],[47,7,47,48,1],[48,7,48,49,1],[49,7,49,23,1],[57,7,57,145,1],[59,7,59,50,1],[60,9,60,132,1],[62,7,62,84,1],[64,7,64,50,1],[65,7,65,27,1],[66,9,66,58,1],[68,7,68,64,1],[77,7,77,46,1],[78,7,78,137,1],[80,7,80,47,1],[81,9,81,130,1],[83,7,83,83,1],[84,7,84,56,1],[86,7,86,122,1],[87,7,87,113,1],[89,9,89,83,1],[90,11,90,108,1],[92,9,92,142,1],[93,9,93,72,1],[95,9,95,56,1],[98,7,98,80,1],[100,9,100,38,1],[101,11,101,114,1],[103,9,105,34,1],[105,34,105,77,1],[105,77,105,80,1],[103,9,105,80,1],[106,9,106,61,1],[107,9,107,25,1],[110,7,110,81,1],[111,9,111,106,1],[113,7,113,79,1],[118,7,118,96,1],[126,7,126,61,1],[127,7,127,140,1],[128,7,128,109,1],[130,7,130,50,1],[131,9,131,130,1],[133,7,133,86,1],[135,7,135,38,1],[137,9,137,82,1],[138,7,138,8,1],[139,12,139,121,1],[141,9,141,145,1],[142,9,142,72,1],[144,9,144,78,1],[145,7,145,8,1],[148,9,148,57,1],[158,7,158,147,1],[160,7,160,52,1],[161,9,161,132,1],[164,7,164,64,1],[166,9,166,37,1],[167,7,167,8,1],[170,9,170,107,1],[172,9,172,39,1],[173,11,173,135,1],[176,7,176,120,1],[176,120,176,136,1],[176,136,176,138,1],[176,7,176,138,1],[177,7,177,134,1],[183,7,183,154,1],[185,7,185,52,1],[186,9,186,140,1],[188,7,190,91,1],[191,7,191,37,1],[192,9,192,133,1],[194,7,196,9,1],[196,9,196,87,1],[196,87,197,9,1],[197,9,197,41,1],[197,41,198,10,1],[194,7,198,10,1],[200,7,200,95,1],[206,7,206,28,1],[207,7,207,72,1],[208,7,208,47,1]]);
    </script>
  </body>
</html>