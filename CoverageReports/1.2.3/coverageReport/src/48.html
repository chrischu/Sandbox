<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Configuration\Schema\SchemaInfoRetriever.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using System.Reflection;
using SolutionInspector.Commons.Extensions;
using SolutionInspector.Configuration.Attributes;

namespace SolutionInspector.Configuration.Schema
{
  /// &lt;summary&gt;
  ///   Retrieves schema info from a &lt;see cref=&quot;Type&quot; /&gt; representing a &lt;see cref=&quot;ConfigurationElement&quot; /&gt;.
  /// &lt;/summary&gt;
  public interface ISchemaInfoRetriever
  {
    ConfigurationElementSchemaInfo GetSchemaInfoForElement (Type configurationElementType);
    ConfigurationDocumentSchemaInfo GetSchemaInfoForDocument (Type configurationDocumentType);
  }

  internal class SchemaInfoRetriever : ISchemaInfoRetriever
  {
    public ConfigurationElementSchemaInfo GetSchemaInfoForElement (Type configurationElementType)
    {
      var elementName = configurationElementType.Name.ToFirstCharLower();
      var possibleEntities = GetPossibleEntities(configurationElementType);
      return new ConfigurationElementSchemaInfo(elementName, 0, int.MaxValue, possibleEntities.Attributes, possibleEntities.Elements);
    }

    public ConfigurationDocumentSchemaInfo GetSchemaInfoForDocument (Type configurationDocumentType)
    {
      var rootElement = GetRootElementSchemaInfo(configurationDocumentType);
      return new ConfigurationDocumentSchemaInfo(rootElement);
    }

    private ConfigurationElementSchemaInfo GetRootElementSchemaInfo (Type configurationDocumentType)
    {
      var configurationDocumentBase = (ConfigurationDocument) Activator.CreateInstance(configurationDocumentType);
      var elementName = configurationDocumentBase.RootElementName;
      var possibleEntities = GetPossibleEntities(configurationDocumentType);
      return new ConfigurationElementSchemaInfo(elementName, 1, 1, possibleEntities.Attributes, possibleEntities.Elements);
    }

    private (IReadOnlyList&lt;ConfigurationAttributeSchemaInfo&gt; Attributes, IReadOnlyList&lt;ConfigurationElementSchemaInfo&gt; Elements)
        GetPossibleEntities (Type configurationType)
    {
      var configurationProperties = configurationType.GetProperties()
          .Select(p =&gt; new { Property = p, Attribute = p.GetCustomAttribute&lt;ConfigurationPropertyAttribute&gt;() })
          .Where(p =&gt; p.Attribute != null)
          .ToList();

      var configurationValues = configurationProperties.Where(x =&gt; x.Attribute is ConfigurationValueAttribute);
      var possibleAttributes = configurationValues.Select(
          x =&gt;
          {
            var attribute = (ConfigurationValueAttribute) x.Attribute;
            var name = attribute.GetXmlName(x.Property.Name);

            return new ConfigurationAttributeSchemaInfo(name, x.Property.PropertyType, attribute.IsRequired, attribute.DefaultValue);
          });

      var configurationSubelements = configurationProperties.Where(x =&gt; x.Attribute is ConfigurationSubelementAttribute);
      var possibleSubelementsFromSubelements = configurationSubelements.Select(
          x =&gt;
          {
            var attribute = (ConfigurationSubelementAttribute) x.Attribute;

            var possibleEntities = GetPossibleEntities(x.Property.PropertyType);
            return new ConfigurationElementSchemaInfo(
                attribute.GetXmlName(x.Property.Name),
                attribute.IsRequired ? 1 : 0,
                1,
                possibleEntities.Attributes,
                possibleEntities.Elements);

          });

      var configurationCollections = configurationProperties.Where(x =&gt; x.Attribute is ConfigurationCollectionAttributeBase);
      var possibleSubelementsFromCollections = configurationCollections.Select(
          x =&gt;
          {
            var attribute = (ConfigurationCollectionAttribute) x.Attribute;
            var elementType = attribute.GetCollectionElementType(x.Property).AssertNotNull();
            var possibleEntities = GetPossibleEntities(elementType);

            if (attribute.IsDefaultCollection)
            {
              return new ConfigurationElementSchemaInfo(
                  attribute.ElementName,
                  attribute.MinimumElementCount,
                  attribute.MaximumElementCount,
                  possibleEntities.Attributes,
                  possibleEntities.Elements);
            }
            else
            {
              return new ConfigurationElementSchemaInfo(
                  attribute.GetXmlName(x.Property.Name).AssertNotNull(),
                  attribute.IsRequired ? 1 : 0,
                  1,
                  new ConfigurationAttributeSchemaInfo[0],
                  new[]
                  {
                      new ConfigurationElementSchemaInfo(
                          attribute.ElementName,
                          attribute.MinimumElementCount,
                          attribute.MaximumElementCount,
                          possibleEntities.Attributes,
                          possibleEntities.Elements)
                  });
            }
          });

      return (possibleAttributes.ToList(), possibleSubelementsFromSubelements.Concat(possibleSubelementsFromCollections).ToList());
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[23,7,23,74,1],[24,7,24,76,1],[25,7,25,135,1],[30,7,30,77,1],[31,7,31,63,1],[36,7,36,115,1],[37,7,37,67,1],[38,7,38,77,1],[39,7,39,124,1],[45,7,46,24,1],[46,24,46,112,1],[46,112,47,23,1],[47,23,47,42,1],[47,42,48,21,1],[45,7,48,21,1],[50,7,50,68,1],[50,68,50,110,1],[50,110,50,112,1],[50,7,50,112,1],[51,7,54,13,1],[54,13,54,71,1],[54,71,55,13,1],[55,13,55,62,1],[55,62,57,13,1],[57,13,57,134,1],[57,134,58,14,1],[51,7,58,14,1],[60,7,60,73,1],[60,73,60,120,1],[60,120,60,122,1],[60,7,60,122,1],[61,7,64,13,1],[64,13,64,76,1],[64,76,66,13,1],[66,13,66,81,1],[66,81,67,13,1],[67,13,72,44,1],[72,44,74,14,1],[61,7,74,14,1],[76,7,76,73,1],[76,73,76,124,1],[76,124,76,126,1],[76,7,76,126,1],[77,7,80,13,1],[80,13,80,76,1],[80,76,81,13,1],[81,13,81,94,1],[81,94,82,13,1],[82,13,82,69,1],[82,69,84,13,1],[84,13,84,47,1],[84,47,86,15,1],[86,15,91,46,1],[91,46,95,15,1],[95,15,108,22,1],[108,22,110,14,1],[77,7,110,14,1],[112,7,112,132,1]]);
    </script>
  </body>
</html>