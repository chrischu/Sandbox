<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Configuration\Dynamic\DynamicConfigurationElementTypeHelper.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using System.Linq;
using System.Xml.Linq;
using SolutionInspector.Commons.Extensions;
using Wrapperator.Interfaces.Reflection;

namespace SolutionInspector.Configuration.Dynamic
{
  /// &lt;summary&gt;
  ///   Resolves the type for a given dynamic configuration element.
  /// &lt;/summary&gt;
  public interface IDynamicConfigurationElementTypeHelper
  {
    Type ResolveElementType (XElement element);
    void ValidateElementCompatibility (XDocument document, ConfigurationElement element);
  }

  internal class DynamicConfigurationElementTypeHelper: IDynamicConfigurationElementTypeHelper
  {
    private readonly ISchemaLocationHelper _schemaLocationHelper;
    private readonly IAssemblyStatic _assembly;

    public DynamicConfigurationElementTypeHelper (ISchemaLocationHelper schemaLocationHelper, IAssemblyStatic assembly)
    {
      _schemaLocationHelper = schemaLocationHelper;
      _assembly = assembly;
    }

    /// &lt;summary&gt;
    ///   Resolves the element type for a given &lt;paramref name=&quot;element&quot; /&gt;.
    /// &lt;/summary&gt;
    /// &lt;exception cref=&quot;DynamicElementTypeResolutionException&quot;&gt;Throw when type resolution fails.&lt;/exception&gt;
    public Type ResolveElementType (XElement element)
    {
      var elementNamespace = element.Name.NamespaceName;
      var elementName = element.Name.LocalName;
      var document = element.Document;

      if (document == null)
        throw new ArgumentException(&quot;The given element is not attached to a document.&quot;, nameof(element));

      var schemaLocations = _schemaLocationHelper.GetSchemaLocations(document);

      if (!schemaLocations.TryGetValue(elementNamespace, out var schemaLocation))
        throw new DynamicElementTypeResolutionException(
            $&quot;For the given element&#39;s namespace &#39;{elementNamespace}&#39; no schema location could be found. &quot; +
            &quot;Make sure that the document&#39;s root element contains an &#39;xsi:schemaLocation&#39; attribute that contains a value pair for the namespace.&quot;);

      var assemblyLocation = Path.ChangeExtension(schemaLocation.AssertNotNull(), &quot;dll&quot;);

      var assembly = LoadAssembly(assemblyLocation);

      var matchingTypes = assembly.GetTypes().Where(t =&gt; t.Name == elementName).ToList();

      if (matchingTypes.Count == 0)
      {
        throw new DynamicElementTypeResolutionException(
            $&quot;Could not find type named &#39;{elementName}&#39; in assembly &#39;{assembly.GetName().Name}&#39; (loaded from &#39;{assemblyLocation}&#39;).&quot;);
      }

      if (matchingTypes.Count &gt; 1)
      {
        var matchingTypesString = matchingTypes.ConvertAndJoin(t =&gt; $&quot;&#39;{t.FullName}&#39;&quot;, &quot;, &quot;);

        throw new DynamicElementTypeResolutionException(
            $&quot;There are multiple types named &#39;{elementName}&#39; in assembly &#39;{assembly.GetName().Name}&#39; &quot; +
            $&quot;(loaded from &#39;{assemblyLocation}&#39;): {matchingTypesString}. This is not supported. &quot; +
            &quot;You need to rename one of the types so that the names become unique.&quot;);
      }

      return matchingTypes[0];
    }

    public void ValidateElementCompatibility (XDocument document, ConfigurationElement element)
    {
      var elementNamespace = element.Element.Name.NamespaceName;
      var schemaLocations = _schemaLocationHelper.GetSchemaLocations(document);

      if (!schemaLocations.TryGetValue(elementNamespace, out var schemaLocation))
      {
        throw new DynamicElementTypeCompatibilityException(
            $&quot;The element belongs to a namespace (&#39;{elementNamespace}&#39;) that is not contained in the schema locations of the containing document.&quot;);
      }

      var containingAssemblyName = element.GetType().Assembly.GetName().Name;
      var referencedAssemblyName = Path.GetFileNameWithoutExtension(schemaLocation);

      if (!schemaLocation.EndsWith($&quot;{containingAssemblyName}.xsd&quot;))
      {
        throw new DynamicElementTypeCompatibilityException(
            $&quot;The element is of a type that does not seem to come from the assembly referenced in the schema location with namespace &#39;{elementNamespace}&#39;. &quot; +
            $&quot;The containing assembly&#39;s name is &#39;{containingAssemblyName}&#39;, but the referenced assembly&#39;s name is {referencedAssemblyName}.&quot;);
      }
    }

    private IAssembly LoadAssembly (string assemblyLocation)
    {
      try
      {
        return _assembly.LoadFrom(assemblyLocation);
      }
      catch (Exception ex)
      {
        throw new DynamicElementTypeResolutionException(
            $&quot;Error while loading assembly containing dynamic element type from &#39;{assemblyLocation}&#39;.&quot;,
            ex);
      }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[24,5,24,120,1],[26,7,26,52,1],[27,7,27,28,1],[36,7,36,57,1],[37,7,37,48,1],[38,7,38,39,1],[40,7,40,28,1],[41,9,41,106,1],[43,7,43,80,1],[45,7,45,82,1],[46,9,48,148,1],[50,7,50,90,1],[52,7,52,53,1],[54,7,54,58,1],[54,58,54,79,1],[54,79,54,90,1],[54,7,54,90,1],[56,7,56,36,1],[58,9,59,135,1],[62,7,62,35,1],[64,9,64,69,1],[64,69,64,86,1],[64,86,64,94,1],[64,9,64,94,1],[66,9,69,85,1],[72,7,72,31,1],[77,7,77,65,1],[78,7,78,80,1],[80,7,80,82,1],[82,9,83,149,1],[86,7,86,78,1],[87,7,87,85,1],[89,7,89,69,1],[91,9,93,143,1],[101,9,101,53,1],[103,7,103,27,1],[105,9,107,17,1],[109,5,109,6,1]]);
    </script>
  </body>
</html>