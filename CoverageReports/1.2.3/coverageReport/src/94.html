<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.TestInfrastructure.Console\Commands\CommandTestsBase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.IO;
using FluentAssertions;
using JetBrains.Annotations;
using ManyConsole;
using NLog;
using NLog.Config;
using NLog.Targets;
using NUnit.Framework;
using SolutionInspector.Commons.Console;

namespace SolutionInspector.TestInfrastructure.Console.Commands
{
  public class CommandTestsBase
  {
    private StringWriter _consoleOutput;

    private LoggingConfiguration _previousLoggingConfiguration;
    private RecordingTarget _logTarget;

    [SetUp]
    public void SetUp ()
    {
      _previousLoggingConfiguration = LogManager.Configuration;

      var configuration = new LoggingConfiguration();
      _logTarget = new RecordingTarget { Name = &quot;test&quot; };
      configuration.AddTarget(_logTarget);
      configuration.LoggingRules.Add(new LoggingRule(&quot;*&quot;, LogLevel.Trace, _logTarget));
      LogManager.Configuration = configuration;

      _consoleOutput = new StringWriter();
    }

    [TearDown]
    public void TearDown ()
    {
      LogManager.Configuration = _previousLoggingConfiguration;
    }

    protected int RunCommand (ConsoleCommand command, params string[] arguments)
    {
      return ConsoleCommandDispatcher.DispatchCommand(command, arguments, _consoleOutput);
    }

    protected void AssertLog(LogLevel level, string message, Exception exception = null)
    {
      LogManager.Flush();
      _logTarget.LogEvents.Should().Contain(new RecordedLogEvent(level, message, exception));
    }

    protected void AssertErrorLog (string message, Exception exception = null)
    {
      AssertLog(LogLevel.Error, message, exception);
    }

    protected void AssertCommandAbortion (int result)
    {
      AssertLog(LogLevel.Info, &quot;Command was aborted&quot;);
      result.Should().Be(ConsoleConstants.SuccessExitCode);
    }

    private class RecordingTarget : Target
    {
      private readonly List&lt;RecordedLogEvent&gt; _logEvents = new List&lt;RecordedLogEvent&gt;();

      protected override void Write ([NotNull] LogEventInfo logEvent)
      {
        _logEvents.Add(new RecordedLogEvent(logEvent.Level, logEvent.Message, logEvent.Exception));
      }

      public IReadOnlyList&lt;RecordedLogEvent&gt; LogEvents =&gt; _logEvents;
    }

    [ExcludeFromCodeCoverage]
    private class RecordedLogEvent
    {
      private readonly LogLevel _level;
      private readonly string _message;
      private readonly Exception _exception;

      public RecordedLogEvent (LogLevel level, string message, [CanBeNull] Exception exception)
      {
        _level = level;
        _message = message;
        _exception = exception;
      }

      private bool Equals (RecordedLogEvent other)
      {
        return _level.Equals(other._level) &amp;&amp; string.Equals(_message, other._message) &amp;&amp; Equals(_exception, other._exception);
      }

      public override bool Equals ([CanBeNull] object obj)
      {
        if (obj is null)
          return false;
        if (this == obj)
          return true;

        return obj.GetType() == GetType() &amp;&amp; Equals((RecordedLogEvent) obj);
      }

      public override int GetHashCode ()
      {
        unchecked
        {
          var hashCode = _level.GetHashCode();
          hashCode = (hashCode * 397) ^ _message.GetHashCode();
          hashCode = (hashCode * 397) ^ (_exception != null ? _exception.GetHashCode() : 0);
          return hashCode;
        }
      }

      public override string ToString ()
      {
        return _exception == null
            ? $&quot;{_level.ToString().ToUpper()}: Message=&#39;{_message}&#39;&quot;
            : $&quot;{_level.ToString().ToUpper()}: Message=&#39;{_message}&#39; Exception=&#39; {_exception.GetType().Name}&#39;&quot;;
      }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,7,26,64,1],[28,7,28,54,1],[29,7,29,58,1],[30,7,30,43,1],[31,7,31,88,1],[32,7,32,48,1],[34,7,34,43,1],[40,7,40,64,1],[45,7,45,91,1],[50,7,50,26,1],[51,7,51,94,1],[56,7,56,53,1],[61,7,61,55,1],[62,7,62,60,1],[67,7,67,89,1],[71,9,71,100,1],[74,59,74,69,1]]);
    </script>
  </body>
</html>