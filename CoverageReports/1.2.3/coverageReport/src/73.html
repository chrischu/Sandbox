<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Development\SolutionInspector\src\SolutionInspector.Internals\ObjectModel\Project.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics.CodeAnalysis;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Xml;
using System.Xml.Linq;
using JetBrains.Annotations;
using Microsoft.Build.Construction;
using Microsoft.Build.Evaluation;
using SolutionInspector.Api.Configuration.MsBuildParsing;
using SolutionInspector.Api.ObjectModel;
using SolutionInspector.Api.Rules;
using SolutionInspector.Commons.Extensions;
using Wrapperator.Interfaces.IO;
using Wrapperator.Wrappers;

namespace SolutionInspector.Internals.ObjectModel
{
  internal sealed class Project : IProject
  {
    private readonly IMsBuildParsingConfiguration _msBuildParsingConfiguration;
    private readonly ProjectCollection _projectCollection;
    private Lazy&lt;ClassifiedReferences&gt; _classifiedReferences;
    private Lazy&lt;XDocument&gt; _projectXml;

    private Project (
      ProjectCollection projectCollection,
      ISolution solution,
      ProjectInSolution projectInSolution,
      Microsoft.Build.Evaluation.Project project,
      IMsBuildParsingConfiguration msBuildParsingConfiguration)
    {
      _projectCollection = projectCollection;

      Solution = solution;

      _msBuildParsingConfiguration = msBuildParsingConfiguration;
      Name = projectInSolution.ProjectName;

      BuildConfigurations =
          projectInSolution.ProjectConfigurations.Values.Select(c =&gt; new BuildConfiguration(c.ConfigurationName, c.PlatformName)).Distinct().ToArray();

      Advanced = new AdvancedProject(project, projectInSolution);

      Guid = Guid.Parse(projectInSolution.ProjectGuid);

      NuGetPackages = BuildNuGetPackages(NuGetPackagesFile).ToArray();

      _classifiedReferences = new Lazy&lt;ClassifiedReferences&gt;(() =&gt; ClassifyReferences(project, NuGetPackages, solution));

      ProjectItems = BuildProjectItems(project.ItemsIgnoringCondition).ToArray();

      ConfigurationProjectItem = BuildConfigurationProjectItem();

      _projectXml = new Lazy&lt;XDocument&gt;(() =&gt; XDocument.Load(ProjectFile.FullName));
    }

    public IAdvancedProject Advanced { get; }

    public Guid Guid { get; }

    public ISolution Solution { get; }

    public string Name { get; }
    public string FolderName =&gt; Path.GetFileName(Advanced.MsBuildProject.DirectoryPath).AssertNotNull();
    public IFileInfo ProjectFile =&gt; Wrapper.Wrap(new FileInfo(Advanced.MsBuildProject.FullPath));
    public IDirectoryInfo ProjectDirectory =&gt; Wrapper.Wrap(new DirectoryInfo(Advanced.MsBuildProject.DirectoryPath));
    public XDocument ProjectXml =&gt; _projectXml.Value;
    public IFileInfo NuGetPackagesFile =&gt; Wrapper.Wrap(new FileInfo(Path.Combine(Advanced.MsBuildProject.DirectoryPath, &quot;packages.config&quot;)));

    public IReadOnlyCollection&lt;BuildConfiguration&gt; BuildConfigurations { get; }

    [CanBeNull]
    public string DefaultNamespace =&gt; Advanced.Properties.GetValueOrDefault(&quot;RootNamespace&quot;)?.DefaultValue;
    [CanBeNull]
    public string AssemblyName =&gt; Advanced.Properties.GetValueOrDefault(&quot;AssemblyName&quot;)?.DefaultValue;

    [CanBeNull]
    public Version TargetFrameworkVersion
    {
      get
      {
        var targetFrameworkVersion = Advanced.Properties.GetValueOrDefault(&quot;TargetFrameworkVersion&quot;)?.DefaultValue;
        return targetFrameworkVersion != null ? Version.Parse(targetFrameworkVersion.TrimStart(&#39;v&#39;)) : null;
      }
    }

    public ProjectOutputType OutputType
      =&gt; Advanced.Properties.GetValueOrDefault(&quot;OutputType&quot;)?.DefaultValue == &quot;Exe&quot; ? ProjectOutputType.Executable : ProjectOutputType.Library;

    public IReadOnlyCollection&lt;INuGetPackage&gt; NuGetPackages { get; }

    public IReadOnlyCollection&lt;IGacReference&gt; GacReferences =&gt; _classifiedReferences.Value.GacReferences;
    public IReadOnlyCollection&lt;INuGetReference&gt; NuGetReferences =&gt; _classifiedReferences.Value.NuGetReferences;
    public IReadOnlyCollection&lt;IFileReference&gt; FileReferences =&gt; _classifiedReferences.Value.FileReferences;
    public IReadOnlyCollection&lt;IProjectReference&gt; ProjectReferences =&gt; _classifiedReferences.Value.ProjectReferences;

    public IReadOnlyCollection&lt;IProjectItem&gt; ProjectItems { get; }

    [CanBeNull]
    public IConfigurationProjectItem ConfigurationProjectItem { get; }

    public string GetIncludePathFor (IProject projectToInclude)
    {
      var includeUri = new Uri(projectToInclude.ProjectFile.FullName);
      var selfUri = new Uri(ProjectFile.FullName);
      var relativeUri = selfUri.MakeRelativeUri(includeUri);
      return relativeUri.OriginalString.Replace(&#39;/&#39;, &#39;\\&#39;);
    }

    string IRuleTarget.Identifier =&gt; Path.GetFileName(Advanced.MsBuildProject.FullPath).AssertNotNull();
    string IRuleTarget.FullPath =&gt; Advanced.MsBuildProject.FullPath;

    public void Dispose ()
    {
      _projectCollection.UnloadAllProjects();
      _projectCollection.Dispose();
    }

    [CanBeNull]
    private IConfigurationProjectItem BuildConfigurationProjectItem ()
    {
      var configurationItem = ProjectItems.SingleOrDefault(
        i =&gt;
          string.Equals(i.Include.Unevaluated, &quot;App.config&quot;, StringComparison.InvariantCultureIgnoreCase)
          || string.Equals(i.Include.Unevaluated, &quot;Web.config&quot;, StringComparison.InvariantCultureIgnoreCase));

      if (configurationItem == null)
        return null;

      return new ConfigurationProjectItem(this, configurationItem);
    }

    private IEnumerable&lt;ProjectItem&gt; BuildProjectItems (ICollection&lt;Microsoft.Build.Evaluation.ProjectItem&gt; msBuildProjectItems)
    {
      var projectItems =
          msBuildProjectItems.Where(i =&gt; !i.IsImported &amp;&amp; _msBuildParsingConfiguration.IsValidProjectItemType(i.ItemType))
              .Select(p =&gt; ProjectItem.FromMsBuildProjectItem(this, p))
              .ToLookup(i =&gt; i.Include.Evaluated);

      foreach (var projectItem in projectItems.SelectMany(g =&gt; g))
      {
        var dependentUpon = projectItem.Metadata.GetValueOrDefault(&quot;DependentUpon&quot;);

        if (dependentUpon != null)
        {
          var dependentUponInclude = Path.Combine(Path.GetDirectoryName(projectItem.Include.Evaluated).AssertNotNull(), dependentUpon);

          var parents = projectItems[dependentUponInclude];
          foreach (var parent in parents)
            projectItem.SetParent(parent);
        }
      }

      return projectItems.SelectMany(g =&gt; g);
    }

    private IEnumerable&lt;INuGetPackage&gt; BuildNuGetPackages (IFileInfo nuGetPackagesFile)
    {
      if (!nuGetPackagesFile.Exists)
        yield break;

      var doc = new XmlDocument();
      doc.Load(nuGetPackagesFile.FullName);

      foreach (var packageElement in doc.SelectNodes(&quot;//package&quot;).AssertNotNull().Cast&lt;XmlElement&gt;())
        yield return NuGetPackage.FromXmlElement(packageElement);
    }

    private ClassifiedReferences ClassifyReferences (
      Microsoft.Build.Evaluation.Project project,
      IReadOnlyCollection&lt;INuGetPackage&gt; nuGetPackages,
      ISolution solution)
    {
      var projectReferences = project.GetItemsIgnoringCondition(&quot;ProjectReference&quot;).Select(r =&gt; new ProjectReference(solution, r));

      var dllReferences =
          project.GetItemsIgnoringCondition(&quot;Reference&quot;)
              .Select(r =&gt; new ReferenceItem(r.EvaluatedInclude, r.Metadata.ToDictionary(m =&gt; m.Name, m =&gt; m.EvaluatedValue)));

      var gacReferences = new List&lt;GacReference&gt;();
      var fileReferences = new List&lt;FileReference&gt;();
      var nuGetReferences = new List&lt;NuGetReference&gt;();

      foreach (var reference in dllReferences)
      {
        if (reference.HintPath == null)
        {
          gacReferences.Add(new GacReference(reference.AssemblyName));
          continue;
        }

        var matchingNuGetPackage =
            nuGetPackages.SingleOrDefault(p =&gt; reference.HintPath.StartsWith($@&quot;..\packages\{p.PackageDirectoryName}&quot;, StringComparison.Ordinal));

        if (matchingNuGetPackage != null)
          nuGetReferences.Add(
            new NuGetReference(
              matchingNuGetPackage,
              reference.AssemblyName,
              reference.Metadata.GetValueOrDefault(&quot;Private&quot;) == &quot;True&quot;,
              reference.HintPath,
              project.DirectoryPath));
        else
          fileReferences.Add(new FileReference(reference.AssemblyName, reference.HintPath, project.DirectoryPath));
      }

      return new ClassifiedReferences(gacReferences, fileReferences, nuGetReferences, projectReferences);
    }

    [SuppressMessage (&quot;Microsoft.Reliability&quot;, &quot;CA2000:Dispose objects before losing scope&quot;, Justification = &quot;Disposal happens in Dispose().&quot;)]
    public static Project FromSolution (
      ISolution solution,
      ProjectInSolution projectInSolution,
      IMsBuildParsingConfiguration msBuildParsingConfiguration)
    {
      var projectCollection = new ProjectCollection();
      var msBuildProject = new Microsoft.Build.Evaluation.Project(
        projectInSolution.AbsolutePath,
        null,
        null,
        projectCollection,
        ProjectLoadSettings.IgnoreMissingImports);

      var project = new Project(
        projectCollection,
        solution,
        projectInSolution,
        msBuildProject,
        msBuildParsingConfiguration);

      return project;
    }

    private class ReferenceItem
    {
      public ReferenceItem (string include, IReadOnlyDictionary&lt;string, string&gt; metadata)
      {
        AssemblyName = new AssemblyName(include);
        Metadata = metadata;
      }

      public AssemblyName AssemblyName { get; }

      [CanBeNull]
      public string HintPath =&gt; Metadata.GetValueOrDefault(&quot;HintPath&quot;);

      public IReadOnlyDictionary&lt;string, string&gt; Metadata { get; }
    }

    private class ClassifiedReferences
    {
      public ClassifiedReferences (
        IEnumerable&lt;GacReference&gt; gacReferences,
        IEnumerable&lt;FileReference&gt; fileReferences,
        IEnumerable&lt;NuGetReference&gt; nuGetReferences,
        IEnumerable&lt;ProjectReference&gt; projectReferences)
      {
        GacReferences = gacReferences.ToArray();
        FileReferences = fileReferences.ToArray();
        NuGetReferences = nuGetReferences.ToArray();
        ProjectReferences = projectReferences.ToArray();
      }

      public IReadOnlyCollection&lt;GacReference&gt; GacReferences { get; }
      public IReadOnlyCollection&lt;FileReference&gt; FileReferences { get; }
      public IReadOnlyCollection&lt;NuGetReference&gt; NuGetReferences { get; }
      public IReadOnlyCollection&lt;ProjectReference&gt; ProjectReferences { get; }
    }
  }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,5,33,64,1],[35,7,35,46,1],[37,7,37,27,1],[39,7,39,66,1],[40,7,40,44,1],[42,7,43,70,1],[43,70,43,129,1],[43,129,43,152,1],[42,7,43,152,1],[45,7,45,66,1],[47,7,47,56,1],[49,7,49,71,1],[51,7,51,68,1],[51,68,51,120,1],[51,120,51,122,1],[51,7,51,122,1],[53,7,53,82,1],[55,7,55,66,1],[57,7,57,47,1],[57,47,57,83,1],[57,83,57,85,1],[57,7,57,85,1],[67,33,67,104,1],[68,37,68,97,1],[69,47,69,117,1],[70,36,70,53,1],[71,43,71,141,1],[76,39,76,107,1],[78,35,78,102,1],[85,9,85,116,1],[86,9,86,109,1],[91,10,91,143,1],[95,64,95,105,1],[96,68,96,111,1],[97,66,97,108,1],[98,72,98,117,1],[107,7,107,71,1],[108,7,108,51,1],[109,7,109,61,1],[110,7,110,60,1],[113,38,113,104,1],[114,36,114,68,1],[118,7,118,46,1],[119,7,119,36,1],[125,7,127,11,1],[127,11,128,109,1],[128,109,128,111,1],[125,7,128,111,1],[130,7,130,37,1],[131,9,131,21,1],[133,7,133,68,1],[138,7,139,42,1],[139,42,139,122,1],[139,122,140,28,1],[140,28,140,71,1],[140,71,141,30,1],[141,30,141,49,1],[141,49,141,51,1],[138,7,141,51,1],[143,16,143,31,1],[143,32,143,34,1],[143,35,143,64,1],[143,64,143,65,1],[143,65,143,66,1],[143,35,143,66,1],[145,9,145,85,1],[147,9,147,35,1],[149,11,149,136,1],[151,11,151,60,1],[152,20,152,30,1],[152,31,152,33,1],[152,34,152,41,1],[153,13,153,43,1],[157,7,157,43,1],[157,43,157,44,1],[157,44,157,46,1],[157,7,157,46,1],[162,7,162,37,1],[163,9,163,21,1],[165,7,165,35,1],[166,7,166,44,1],[168,16,168,34,1],[168,35,168,37,1],[168,38,168,101,1],[169,9,169,66,1],[170,5,170,6,1],[177,7,177,97,1],[177,97,177,130,1],[177,130,177,132,1],[177,7,177,132,1],[179,7,181,28,1],[181,28,181,95,1],[181,95,181,101,1],[181,101,181,108,1],[181,108,181,124,1],[181,124,181,126,1],[181,28,181,126,1],[181,126,181,128,1],[179,7,181,128,1],[183,7,183,52,1],[184,7,184,54,1],[185,7,185,56,1],[187,16,187,29,1],[187,30,187,32,1],[187,33,187,46,1],[189,9,189,40,1],[191,11,191,71,1],[192,11,192,20,1],[195,9,196,48,1],[196,48,196,145,1],[196,145,196,147,1],[195,9,196,147,1],[198,9,198,42,1],[199,11,205,39,1],[207,11,207,116,1],[210,7,210,106,1],[219,7,219,55,1],[220,7,225,51,1],[227,7,232,38,1],[234,7,234,22,1],[239,7,239,90,1],[241,9,241,50,1],[242,9,242,29,1],[248,33,248,71,1],[255,7,259,57,1],[261,9,261,49,1],[262,9,262,51,1],[263,9,263,53,1],[264,9,264,57,1]]);
    </script>
  </body>
</html>